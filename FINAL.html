<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Your Travel Assistant</title>

  <style>
    :root{
      --bg0:#050a16;
      --bg1:#071326;
      --bg2:#0b1d3a;

      --panel:rgba(255,255,255,.055);
      --panel2:rgba(255,255,255,.035);
      --line:rgba(255,255,255,.10);

      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);

      --chip:rgba(255,255,255,.06);
      --chipLine:rgba(255,255,255,.12);

      --accent:#4aa3ff;
      --accent2:#7b61ff;
      --danger:#ff5b6b;

      --shadow: 0 18px 55px rgba(0,0,0,.45);
      --shadow2: 0 16px 40px rgba(0,0,0,.35);
      --radius:20px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 800px at 55% 20%, #142b66 0%, rgba(9,18,41,.0) 55%),
        radial-gradient(900px 700px at 20% 0%, #132251 0%, rgba(9,18,41,.0) 55%),
        radial-gradient(1100px 750px at 80% 100%, rgba(123,97,255,.18) 0%, rgba(9,18,41,0) 50%),
        linear-gradient(140deg, var(--bg1), var(--bg0));
      overflow:hidden;
    }

    /* subtle noise */
    body:before{
      content:"";
      position:fixed; inset:0;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='200' height='200' filter='url(%23n)' opacity='.12'/%3E%3C/svg%3E");
      opacity:.18;
      pointer-events:none;
      mix-blend-mode:overlay;
    }

    .app{
      height:100vh;
      width:100vw;
      padding:14px;
      display:flex;
      gap:14px;
    }

    /* ===== Left Sidebar ===== */
    .sidebar{
      width:360px;
      min-width:320px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.09);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      position:relative;
    }
    .sidebar:after{
      content:"";
      position:absolute; inset:-2px;
      border-radius:var(--radius);
      background: radial-gradient(800px 400px at 20% 0%, rgba(74,163,255,.12), transparent 55%),
                  radial-gradient(800px 500px at 80% 100%, rgba(123,97,255,.10), transparent 60%);
      pointer-events:none;
      z-index:0;
    }
    .sidebar > *{position:relative; z-index:1}

    .sbTop{
      padding:14px;
      display:flex;
      align-items:center;
      gap:10px;
    }

    .btn{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
      border-radius:16px;
      padding:12px 14px;
      cursor:pointer;
      transition:.16s ease;
      user-select:none;
      font-weight:750;
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
    }
    .btn:hover{transform:translateY(-1px); background:rgba(255,255,255,.09)}
    .btn:active{transform:translateY(0px) scale(.99)}
    .btn.primary{
      flex:1;
      display:flex;
      align-items:center;
      gap:10px;
      background:linear-gradient(135deg, rgba(74,163,255,.26), rgba(123,97,255,.22));
      border-color:rgba(74,163,255,.22);
      justify-content:flex-start;
    }
    .btn.icon{
      width:52px;
      padding:12px 0;
      display:flex;
      justify-content:center;
      align-items:center;
      border-radius:18px;
      background:rgba(0,0,0,.18);
    }
    .btn.danger{
      border-color:rgba(255,91,107,.25);
      background:rgba(255,91,107,.10);
    }
    .btn.danger:hover{background:rgba(255,91,107,.14)}

    .sbMid{
      padding:0 14px 14px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .sbLabelRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-top:6px;
      color:var(--muted);
      letter-spacing:.12em;
      font-size:12px;
    }
    .sbCount{ color:var(--muted); font-size:13px; }

    .search{
      width:100%;
      border-radius:14px;
      padding:12px 12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
      transition:.15s ease;
    }
    .search:focus{
      border-color:rgba(74,163,255,.35);
      box-shadow: 0 0 0 4px rgba(74,163,255,.12);
    }

    .historyList{
      flex:1;
      overflow:auto;
      padding:0 10px 14px 10px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .historyList::-webkit-scrollbar{width:10px}
    .historyList::-webkit-scrollbar-thumb{
      background:rgba(255,255,255,.10);
      border-radius:999px;
      border:2px solid rgba(0,0,0,.25);
    }

    .historyItem{
      padding:12px 12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.09);
      background:linear-gradient(180deg, rgba(255,255,255,.045), rgba(255,255,255,.028));
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      transition:.16s ease;
      box-shadow: 0 14px 28px rgba(0,0,0,.18);
    }
    .historyItem:hover{
      transform:translateY(-1px);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.035));
    }
    .historyItem.active{
      outline:2px solid rgba(74,163,255,.26);
    }

    .hLeft{min-width:0}
    .hTitle{
      font-weight:900;
      font-size:14px;
      max-width:230px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .hSub{
      margin-top:4px;
      font-size:12px;
      color:var(--muted);
      max-width:230px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .hDel{
      width:30px; height:30px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      color:var(--text);
      cursor:pointer;
      transition:.14s ease;
    }
    .hDel:hover{
      border-color:rgba(255,91,107,.35);
      background:rgba(255,91,107,.12);
    }

    /* ===== Main ===== */
    .main{
      flex:1;
      min-width:0;
      background:linear-gradient(180deg, rgba(255,255,255,.055), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.09);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      position:relative;
    }
    .main:before{
      content:"";
      position:absolute; inset:-2px;
      border-radius:var(--radius);
      background:
        radial-gradient(800px 420px at 20% 0%, rgba(74,163,255,.10), transparent 60%),
        radial-gradient(900px 520px at 70% 30%, rgba(123,97,255,.08), transparent 62%);
      pointer-events:none;
    }

    .topbar{
      height:66px;
      padding:12px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.10);
      position:relative;
      z-index:2;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
      font-weight:950;
      letter-spacing:.2px;
    }
    .dot{
      width:10px; height:10px;
      border-radius:999px;
      background: radial-gradient(circle at 30% 30%, rgba(74,163,255,.95), rgba(123,97,255,.55));
      box-shadow: 0 0 0 4px rgba(74,163,255,.08);
      flex:0 0 auto;
    }
    .brandText{
      max-width:420px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      font-size:18px;
    }

    .topRight{
      display:flex;
      align-items:center;
      gap:14px;
      color:var(--muted);
      font-weight:800;
    }

    .lang{
      display:flex;
      gap:6px;
      padding:6px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.16);
    }
    .langBtn{
      padding:8px 12px;
      border-radius:999px;
      background:transparent;
      color:var(--muted);
      border:1px solid transparent;
      cursor:pointer;
      font-weight:900;
      transition:.15s ease;
    }
    .langBtn.active{
      color:var(--text);
      background:rgba(255,255,255,.08);
      border-color:rgba(255,255,255,.12);
    }

    .linkBtn{
      background:transparent;
      border:0;
      color:rgba(255,255,255,.75);
      cursor:pointer;
      font-weight:900;
      padding:10px 6px;
      transition:.15s ease;
    }
    .linkBtn:hover{color:rgba(255,255,255,.95); transform: translateY(-1px);}

    /* Center hero */
    .hero{
      padding:18px 18px 10px 18px;
      text-align:center;
      position:relative;
      z-index:1;
    }
    .hero h1{
      margin:6px 0 6px 0;
      font-size:44px;
      letter-spacing:.2px;
      text-shadow: 0 10px 35px rgba(0,0,0,.45);
    }
    .hero p{
      margin:0;
      color:var(--muted);
      font-size:14px;
    }

    /* Chat */
    .chatArea{
      flex:1;
      padding:8px 18px 0 18px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      position:relative;
      z-index:1;
    }
    .chat{
      flex:1;
      overflow:auto;
      padding:8px 8px 0 8px;
      display:flex;
      flex-direction:column;
      gap:14px;
      scroll-behavior:smooth;
    }
    .chat::-webkit-scrollbar{width:10px}
    .chat::-webkit-scrollbar-thumb{
      background:rgba(255,255,255,.10);
      border-radius:999px;
      border:2px solid rgba(0,0,0,.25);
    }

    .row{display:flex; align-items:flex-end; gap:10px}
    .row.bot{justify-content:flex-start}
    .row.user{justify-content:flex-end}
    .avatar{
      width:34px; height:34px;
      border-radius:14px;
      background:rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:950;
      color:rgba(255,255,255,.85);
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
      flex:0 0 auto;
    }

    .bubble{
      max-width:60%;
      padding:14px 16px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.045);
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
      line-height:1.35;
      white-space:pre-wrap;
      animation: pop .16s ease;
    }
    @keyframes pop{from{transform:translateY(4px); opacity:.0}to{transform:translateY(0); opacity:1}}
    .bubble.user{
      background:linear-gradient(135deg, rgba(74,163,255,.22), rgba(123,97,255,.18));
      border-color:rgba(74,163,255,.22);
    }

    /* Buttons inside bot responses */
    .btnRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .miniBtn{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.88);
      cursor:pointer;
      font-weight:800;
      font-size:13px;
      transition:.15s ease;
    }
    .miniBtn:hover{transform:translateY(-1px); background:rgba(255,255,255,.09)}

    /* Typing indicator */
    .typing{
      display:none;
      padding:0 18px 8px 18px;
      position:relative;
      z-index:1;
    }
    .typingInner{
      display:flex;
      align-items:center;
      gap:10px;
      width:fit-content;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.16);
      box-shadow: var(--shadow2);
    }
    .dots{display:flex; gap:6px}
    .tdot{width:7px; height:7px; border-radius:50%; background:rgba(255,255,255,.65); animation:b 1s infinite ease-in-out}
    .tdot:nth-child(2){animation-delay:.15s}
    .tdot:nth-child(3){animation-delay:.3s}
    @keyframes b{0%,100%{transform:translateY(0); opacity:.55}50%{transform:translateY(-4px); opacity:1}}
    .typingText{font-size:12px; color:var(--muted)}

    /* Chips */
    .chips{
      padding:10px 18px 12px 18px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      border-top:1px solid rgba(255,255,255,.06);
      position:relative;
      z-index:1;
    }
    .chip{
      padding:8px 12px;
      border-radius:999px;
      background:var(--chip);
      border:1px solid var(--chipLine);
      color:rgba(255,255,255,.85);
      cursor:pointer;
      font-size:13px;
      transition:.15s ease;
      user-select:none;
      box-shadow: 0 10px 24px rgba(0,0,0,.18);
    }
    .chip:hover{transform:translateY(-1px); background:rgba(255,255,255,.085)}

    /* Composer */
    .composer{
      padding:14px 18px;
      border-top:1px solid rgba(255,255,255,.08);
      display:flex;
      gap:12px;
      align-items:center;
      background:rgba(0,0,0,.10);
      position:relative;
      z-index:2;
    }
    .input{
      flex:1;
      border-radius:16px;
      padding:14px 14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
      min-width:0;
      font-size:14px;
      transition:.15s ease;
    }
    .input:focus{
      border-color:rgba(74,163,255,.35);
      box-shadow: 0 0 0 4px rgba(74,163,255,.12);
    }
    .micBtn{
      width:52px;
      height:52px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      cursor:pointer;
      display:flex;
      justify-content:center;
      align-items:center;
      font-size:18px;
      transition:.15s ease;
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
    }
    .micBtn:hover{transform:translateY(-1px); background:rgba(255,255,255,.09)}
    .micBtn.rec{
      border-color:rgba(255,91,107,.35);
      background:rgba(255,91,107,.12);
    }
    .sendBtn{
      padding:14px 18px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.07);
      color:var(--text);
      font-weight:950;
      cursor:pointer;
      transition:.15s ease;
      letter-spacing:.02em;
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
    }
    .sendBtn:hover{transform:translateY(-1px); background:rgba(255,255,255,.10)}
    .sendBtn:disabled{
      opacity:.55;
      cursor:not-allowed;
      transform:none;
    }

    /* Toast */
    .toast{
      position:fixed;
      right:18px; bottom:18px;
      background:rgba(0,0,0,.62);
      border:1px solid rgba(255,255,255,.10);
      padding:12px 14px;
      border-radius:14px;
      color:var(--text);
      transform: translateY(20px);
      opacity:0;
      pointer-events:none;
      transition:.18s ease;
      z-index:80;
      box-shadow: 0 18px 45px rgba(0,0,0,.45);
    }
    .toast.show{opacity:1; transform: translateY(0)}

    /* Modal (generic) */
    .modalBackdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.58);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:90;
      padding:14px;
    }
    .modal{
      width:420px;
      max-width:95vw;
      border-radius:22px;
      background:rgba(12,25,48,.92);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 25px 75px rgba(0,0,0,.55);
      padding:14px;
      backdrop-filter: blur(14px);
      position:relative;
      overflow:hidden;
      animation: modalIn .16s ease;
    }
    @keyframes modalIn{from{transform:translateY(10px); opacity:.0}to{transform:translateY(0); opacity:1}}
    .modal:before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(700px 420px at 20% 0%, rgba(74,163,255,.16), transparent 55%),
                  radial-gradient(700px 520px at 80% 100%, rgba(123,97,255,.12), transparent 60%);
      pointer-events:none;
      border-radius:22px;
    }
    .modal > *{position:relative; z-index:1}

    .modalHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:2px 4px 10px 4px;
    }
    .modalTitle{font-weight:1000; font-size:16px}
    .closeBtn{
      width:42px; height:42px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      color:var(--text);
      cursor:pointer;
      transition:.15s ease;
    }
    .closeBtn:hover{transform:translateY(-1px); background:rgba(255,255,255,.06)}

    .modalBody{
      display:flex;
      flex-direction:column;
      gap:10px;
      padding:0 4px 6px 4px;
    }
    .muted{color:var(--muted); font-size:13px}
    .wide{width:100%}

    .modalActions{
      display:flex;
      gap:10px;
      margin-top:4px;
    }
    .ghostBtn{
      padding:12px 14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
      color:var(--text);
      font-weight:950;
      cursor:pointer;
      transition:.15s ease;
      flex:1;
    }
    .ghostBtn:hover{transform:translateY(-1px); background:rgba(255,255,255,.08)}
    .dangerBtn{
      padding:12px 14px;
      border-radius:18px;
      border:1px solid rgba(255,91,107,.30);
      background:rgba(255,91,107,.14);
      color:var(--text);
      font-weight:1000;
      cursor:pointer;
      transition:.15s ease;
      flex:1;
    }
    .dangerBtn:hover{transform:translateY(-1px); background:rgba(255,91,107,.18)}
  </style>
</head>

<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sbTop">
        <button id="newChatBtn" class="btn primary" type="button">
          <span style="font-size:18px">ï¼‹</span>
          <span data-i18n="newChat">New Chat</span>
        </button>
        <button id="clearAllBtn" class="btn icon danger" type="button" title="Clear all">ðŸ—‘</button>
      </div>

      <div class="sbMid">
        <div class="sbLabelRow">
          <span data-i18n="history">HISTORY</span>
          <span id="historyCount" class="sbCount">0/0</span>
        </div>
        <input id="historySearch" class="search" type="text" placeholder="Search chats..." />
      </div>

      <div id="historyList" class="historyList"></div>
    </aside>

    <!-- Main -->
    <main class="main">
      <header class="topbar">
        <div class="brand">
          <span class="dot"></span>
          <span id="brandName" class="brandText" data-i18n="brandSmall">Your Travel Assistant</span>
        </div>

        <div class="topRight">
          <div class="lang">
            <button id="btnMN" class="langBtn" type="button">MN</button>
            <button id="btnEN" class="langBtn active" type="button">EN</button>
          </div>
          <button id="signInBtn" class="linkBtn" type="button" data-i18n="signIn">Sign in</button>
          <button id="signUpBtn" class="linkBtn" type="button" data-i18n="signUp">Sign up</button>
        </div>
      </header>

      <div class="hero">
        <h1 data-i18n="heroTitle">Your Travel Assistant</h1>
        <p data-i18n="heroSub">Type your question</p>
      </div>

      <section class="chatArea">
        <div id="chat" class="chat"></div>
      </section>

      <div id="typingIndicator" class="typing">
        <div class="typingInner">
          <div class="dots"><span class="tdot"></span><span class="tdot"></span><span class="tdot"></span></div>
          <div class="typingText" data-i18n="typing">Bot is typingâ€¦</div>
        </div>
      </div>

      <div class="chips" id="chips"></div>

      <footer class="composer">
        <input id="messageInput" class="input" type="text" placeholder="Message... (Enter = send, Shift+Enter = newline)" />
        <button id="micBtn" class="micBtn" type="button" title="Voice to text">ðŸŽ¤</button>
        <button id="sendBtn" class="sendBtn" type="button" data-i18n="send">SEND</button>
      </footer>
    </main>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Auth Modal -->
  <div id="authModalBackdrop" class="modalBackdrop">
    <div class="modal">
      <div class="modalHead">
        <div id="authModalTitle" class="modalTitle">Sign in</div>
        <button id="authModalClose" class="closeBtn" type="button">âœ•</button>
      </div>
      <div class="modalBody">
        <div id="authModalText" class="muted">Demo only. Connect real auth later.</div>
        <input class="input" type="email" placeholder="Email" autocomplete="email"/>
        <input class="input" type="password" placeholder="Password" autocomplete="current-password"/>
        <button class="sendBtn wide" type="button">Continue</button>
      </div>
    </div>
  </div>

  <!-- Confirm Modal (Delete/ Clear) -->
  <div id="confirmBackdrop" class="modalBackdrop">
    <div class="modal">
      <div class="modalHead">
        <div id="confirmTitle" class="modalTitle">Confirm</div>
        <button id="confirmClose" class="closeBtn" type="button">âœ•</button>
      </div>
      <div class="modalBody">
        <div id="confirmText" class="muted">Are you sure?</div>
        <div class="modalActions">
          <button id="confirmCancel" class="ghostBtn" type="button">Cancel</button>
          <button id="confirmOk" class="dangerBtn" type="button">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==========================
    // CONFIG
    // ==========================
    const RASA_URL = "http://localhost:5005/webhooks/rest/webhook";
    const STORAGE_KEY = "travel_ui_chats_v3";
    const ACTIVE_KEY  = "travel_ui_active_v3";
    let currentLang = "en";
    let isSending = false;

    // ==========================
    // i18n
    // ==========================
    const I18N = {
      en: {
        newChat:"New Chat",
        history:"HISTORY",
        brandSmall:"Your Travel Assistant",
        heroTitle:"Your Travel Assistant",
        heroSub:"Type your question",
        signIn:"Sign in",
        signUp:"Sign up",
        send:"SEND",
        typing:"Bot is typingâ€¦",
        welcome:"Hello ðŸ‘‹  Type â€œtravelâ€ to start. (Or click a chip below.)",
        toastRasa:"Error: Is Rasa running on localhost:5005?",
        toastDel:"Chat deleted.",
        toastClear:"All chats cleared.",
        modalInTitle:"Sign in",
        modalUpTitle:"Sign up",
        modalText:"Demo only. Connect real auth later.",
        searchPH:"Search chats...",
        msgPH:"Message... (Enter = send, Shift+Enter = newline)",
        empty:"empty",
        confirmTitle:"Confirm",
        confirmChat:"Are you sure you want to delete this chat?",
        confirmAll:"Are you sure you want to clear ALL chat history?",
        cancel:"Cancel",
        del:"Delete",
        clear:"Clear"
      },
      mn: {
        newChat:"Ð¨Ð¸Ð½Ñ Ñ‡Ð°Ñ‚",
        history:"Ð¢Ò®Ò®Ð¥",
        brandSmall:"Ð¢Ð°Ð½Ñ‹ Ð°ÑÐ»Ð»Ñ‹Ð½ Ñ‚ÑƒÑÐ»Ð°Ñ…",
        heroTitle:"Ð¢Ð°Ð½Ñ‹ Ð°ÑÐ»Ð»Ñ‹Ð½ Ñ‚ÑƒÑÐ»Ð°Ñ…",
        heroSub:"ÐÑÑƒÑƒÐ»Ñ‚Ð°Ð° Ð±Ð¸Ñ‡ÑÑÑ€ÑÐ¹",
        signIn:"ÐÑÐ²Ñ‚Ñ€ÑÑ…",
        signUp:"Ð‘Ò¯Ñ€Ñ‚Ð³Ò¯Ò¯Ð»ÑÑ…",
        send:"Ð˜Ð›Ð“Ð­Ð­Ð¥",
        typing:"Ð‘Ð¾Ñ‚ Ð±Ð¸Ñ‡Ð¸Ð¶ Ð±Ð°Ð¹Ð½Ð°â€¦",
        welcome:"Ð¡Ð°Ð¹Ð½ Ð±Ð°Ð¹Ð½Ð° ÑƒÑƒ ðŸ‘‹  â€œÐ°ÑÐ»Ð°Ð»â€ Ð³ÑÐ¶ Ð±Ð¸Ñ‡ÑÑÐ´ ÑÑ…Ð»Ò¯Ò¯Ð»ÑÑÑ€ÑÐ¹. (Ð­ÑÐ²ÑÐ» Ð´Ð¾Ð¾Ñ€Ñ… Ñ‚Ð¾Ð²Ñ‡ÑƒÑƒÐ´Ñ‹Ð³ Ð´Ð°Ñ€Ð¶ Ð±Ð¾Ð»Ð½Ð¾.)",
        toastRasa:"ÐÐ»Ð´Ð°Ð°: Rasa (localhost:5005) Ð°Ð¶Ð¸Ð»Ð»Ð°Ð¶ Ð±Ð°Ð¹Ð½Ð° ÑƒÑƒ?",
        toastDel:"Ð§Ð°Ñ‚ ÑƒÑÑ‚Ð³Ð°Ð»Ð°Ð°.",
        toastClear:"Ð‘Ò¯Ñ… Ñ‚Ò¯Ò¯Ñ… Ñ†ÑÐ²ÑÑ€Ð»ÑÐ³Ð´Ð»ÑÑ.",
        modalInTitle:"ÐÑÐ²Ñ‚Ñ€ÑÑ…",
        modalUpTitle:"Ð‘Ò¯Ñ€Ñ‚Ð³Ò¯Ò¯Ð»ÑÑ…",
        modalText:"Ð”ÐµÐ¼Ð¾. Ð”Ð°Ñ€Ð°Ð° Ð½ÑŒ Ð¶Ð¸Ð½Ñ…ÑÐ½Ñ auth Ñ…Ð¾Ð»Ð±Ð¾Ð½Ð¾.",
        searchPH:"Ð§Ð°Ñ‚ÑƒÑƒÐ´ Ñ…Ð°Ð¹Ñ…...",
        msgPH:"Message... (Enter = Ð¸Ð»Ð³ÑÑÑ…, Shift+Enter = ÑˆÐ¸Ð½Ñ Ð¼Ó©Ñ€)",
        empty:"Ñ…Ð¾Ð¾ÑÐ¾Ð½",
        confirmTitle:"Ð‘Ð°Ñ‚Ð°Ð»Ð³Ð°Ð°Ð¶ÑƒÑƒÐ»Ð°Ñ…",
        confirmChat:"Ð¢Ð° ÑÐ½Ñ Ñ‡Ð°Ñ‚Ñ‹Ð³ ÑƒÑÑ‚Ð³Ð°Ñ…Ð´Ð°Ð° Ð¸Ñ‚Ð³ÑÐ»Ñ‚ÑÐ¹ Ð±Ð°Ð¹Ð½Ð° ÑƒÑƒ?",
        confirmAll:"Ð¢Ð° Ð±Ò¯Ñ… Ñ‡Ð°Ñ‚Ð½Ñ‹ Ñ‚Ò¯Ò¯Ñ…Ð¸Ð¹Ð³ Ñ†ÑÐ²ÑÑ€Ð»ÑÑ…Ð´ÑÑ Ð¸Ñ‚Ð³ÑÐ»Ñ‚ÑÐ¹ Ð±Ð°Ð¹Ð½Ð° ÑƒÑƒ?",
        cancel:"Ð‘Ð¾Ð»Ð¸Ñ…",
        del:"Ð£ÑÑ‚Ð³Ð°Ñ…",
        clear:"Ð¦ÑÐ²ÑÑ€Ð»ÑÑ…"
      }
    };
    const t = (k)=> (I18N[currentLang] && I18N[currentLang][k]) ? I18N[currentLang][k] : k;

    function applyI18n(){
      document.querySelectorAll("[data-i18n]").forEach(el=>{
        const k = el.getAttribute("data-i18n");
        el.textContent = t(k);
      });
      document.getElementById("historySearch").placeholder = t("searchPH");
      document.getElementById("messageInput").placeholder = t("msgPH");
      renderChatFromStorage();
      renderHistory(document.getElementById("historySearch").value);
      renderChips();
    }

    // ==========================
    // Storage
    // ==========================
    function uid(){ return "chat_" + Date.now() + "_" + Math.random().toString(16).slice(2); }

    function loadChats(){
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
      catch { return []; }
    }
    function saveChats(chats){ localStorage.setItem(STORAGE_KEY, JSON.stringify(chats)); }

    function ensureChat(id){
      const chats = loadChats();
      if(!chats.find(c=>c.id===id)){
        chats.unshift({ id, title:"Ð°ÑÐ»Ð°Ð»", createdAt:Date.now(), messages:[] });
        saveChats(chats);
      }
    }
    function getActiveId(){
      let id = localStorage.getItem(ACTIVE_KEY);
      if(!id){
        id = uid();
        localStorage.setItem(ACTIVE_KEY, id);
        ensureChat(id);
      } else ensureChat(id);
      return id;
    }
    function setActiveId(id){
      localStorage.setItem(ACTIVE_KEY, id);
      ensureChat(id);
    }
    function getActiveChat(){
      const id = getActiveId();
      return loadChats().find(c=>c.id===id);
    }
    function updateActiveChat(fn){
      const id = getActiveId();
      const chats = loadChats();
      const idx = chats.findIndex(c=>c.id===id);
      if(idx<0) return;
      fn(chats[idx]);
      saveChats(chats);
    }

    // ==========================
    // UI
    // ==========================
    const chatEl = document.getElementById("chat");
    const typingEl = document.getElementById("typingIndicator");
    const toastEl = document.getElementById("toast");

    function showToast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(()=>toastEl.classList.remove("show"), 2300);
    }
    function setTyping(on){ typingEl.style.display = on ? "block" : "none"; }

    function splitLang(text){
      if(!text) return "";
      const parts = String(text).split("||");
      if(parts.length < 2) return text;
      return currentLang==="mn" ? parts[0].trim() : parts[1].trim();
    }

    function clearChatUI(){ chatEl.innerHTML=""; }

    function addRow(role){
      const row = document.createElement("div");
      row.className = "row " + role;

      if(role==="bot"){
        const av = document.createElement("div");
        av.className = "avatar";
        av.textContent = "AI";
        row.appendChild(av);
      }
      return row;
    }

    function addBubble(role, text){
      const row = addRow(role);
      const bubble = document.createElement("div");
      bubble.className = "bubble " + (role==="user" ? "user" : "");
      bubble.textContent = text;

      row.appendChild(bubble);

      if(role==="user"){
        const av = document.createElement("div");
        av.className = "avatar";
        av.textContent = "U";
        row.appendChild(av);
      }

      chatEl.appendChild(row);
      chatEl.scrollTop = chatEl.scrollHeight;
      return bubble;
    }

    function addBotRichMessage(payload){
      // payload can include: text, image, buttons, attachment, custom
      const row = addRow("bot");
      const bubble = document.createElement("div");
      bubble.className = "bubble";

      if(payload.text){
        bubble.textContent = splitLang(payload.text);
      } else {
        bubble.textContent = ""; // may add other content
      }

      // Image
      if(payload.image){
        const img = document.createElement("img");
        img.src = payload.image;
        img.alt = "image";
        img.style.marginTop = "10px";
        img.style.maxWidth = "100%";
        img.style.borderRadius = "14px";
        img.style.border = "1px solid rgba(255,255,255,.10)";
        bubble.appendChild(img);
      }

      // Attachment (often URL)
      if(payload.attachment){
        const a = document.createElement("a");
        a.href = payload.attachment;
        a.target = "_blank";
        a.rel = "noreferrer";
        a.textContent = payload.attachment;
        a.style.display = "block";
        a.style.marginTop = "10px";
        a.style.color = "rgba(74,163,255,.95)";
        a.style.textDecoration = "none";
        bubble.appendChild(a);
      }

      // Buttons
      if(Array.isArray(payload.buttons) && payload.buttons.length){
        const wrap = document.createElement("div");
        wrap.className = "btnRow";
        payload.buttons.forEach(b=>{
          const mb = document.createElement("button");
          mb.className = "miniBtn";
          mb.type = "button";
          mb.textContent = splitLang(b.title || b.payload || "Select");
          mb.onclick = ()=>{
            // prefer payload if present, else title
            const msg = b.payload || b.title || "";
            handleSend(msg);
          };
          wrap.appendChild(mb);
        });
        bubble.appendChild(wrap);
      }

      // Custom JSON fallback
      if(payload.custom && !payload.text && !payload.image && !payload.attachment && !payload.buttons){
        const pre = document.createElement("pre");
        pre.textContent = JSON.stringify(payload.custom, null, 2);
        pre.style.margin="10px 0 0 0";
        pre.style.fontSize="12px";
        pre.style.color="rgba(255,255,255,.75)";
        pre.style.whiteSpace="pre-wrap";
        bubble.appendChild(pre);
      }

      row.appendChild(bubble);
      chatEl.appendChild(row);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function addMessage(role, text){
      updateActiveChat(chat=>{
        chat.messages.push({ role, text, ts:Date.now() });
        if(role==="user" && (!chat.title || chat.title==="Ð°ÑÐ»Ð°Ð»")){
          chat.title = text.slice(0,24);
        }
      });
      addBubble(role, role==="bot" ? splitLang(text) : text);
      renderHistory(document.getElementById("historySearch").value);
    }

    function addBotPayloadToStorage(payload){
      // store as text if possible, else store a JSON string
      const asText = payload.text ? payload.text : JSON.stringify(payload);
      updateActiveChat(chat=>{
        chat.messages.push({ role:"bot", text: asText, ts:Date.now(), payload });
      });
    }

    function renderChatFromStorage(){
      clearChatUI();
      const chat = getActiveChat();
      if(!chat) return;
      chat.messages.forEach(m=>{
        if(m.role==="bot" && m.payload){
          addBotRichMessage(m.payload);
        } else {
          addBubble(m.role, m.role==="bot" ? splitLang(m.text) : m.text);
        }
      });
    }

    // ==========================
    // History
    // ==========================
    function renderHistory(filter=""){
      const list = document.getElementById("historyList");
      const counter = document.getElementById("historyCount");
      const chats = loadChats();
      const active = getActiveId();

      const f = (filter||"").toLowerCase();
      const filtered = f ? chats.filter(c => (c.title||"").toLowerCase().includes(f)) : chats;

      counter.textContent = `${Math.min(filtered.length, chats.length)}/${chats.length}`;
      list.innerHTML = "";

      filtered.forEach((c)=>{
        const item = document.createElement("div");
        item.className = "historyItem" + (c.id===active ? " active":"");

        const left = document.createElement("div");
        left.className = "hLeft";

        const title = document.createElement("div");
        title.className = "hTitle";
        title.textContent = c.title || "Ð°ÑÐ»Ð°Ð»";

        const last = (c.messages && c.messages.length) ? c.messages[c.messages.length-1].text : "";
        const sub = document.createElement("div");
        sub.className = "hSub";
        sub.textContent = last
          ? (last.length>44 ? last.slice(0,44)+"â€¦" : last)
          : t("empty");

        left.appendChild(title);
        left.appendChild(sub);

        const del = document.createElement("button");
        del.className = "hDel";
        del.textContent = "Ã—";
        del.onclick = (e)=>{ e.stopPropagation(); confirmDeleteChat(c.id); };

        item.onclick = ()=>{
          setActiveId(c.id);
          renderHistory(document.getElementById("historySearch").value);
          renderChatFromStorage();
        };

        item.appendChild(left);
        item.appendChild(del);
        list.appendChild(item);
      });
    }

    function deleteChatNow(id){
      const chats = loadChats().filter(x=>x.id!==id);
      saveChats(chats);

      if(localStorage.getItem(ACTIVE_KEY)===id){
        localStorage.removeItem(ACTIVE_KEY);
        newChat(true);
      }else{
        renderHistory(document.getElementById("historySearch").value);
      }
      showToast(t("toastDel"));
    }

    function clearAllChatsNow(){
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(ACTIVE_KEY);
      showToast(t("toastClear"));
      newChat(true);
    }

    function newChat(skipWelcome=false){
      const id = uid();
      setActiveId(id);
      updateActiveChat(chat=>{
        chat.title = "Ð°ÑÐ»Ð°Ð»";
        chat.messages = [];
      });
      renderHistory(document.getElementById("historySearch").value);
      renderChatFromStorage();
      if(!skipWelcome){
        addMessage("bot", `${t("welcome")}||${t("welcome")}`);
      }
    }

    // ==========================
    // Chips
    // ==========================
    const CHIP_DATA = [
      { en:"travel", mn:"Ð°ÑÐ»Ð°Ð»" },
      { en:"help", mn:"Ñ‚ÑƒÑÐ»Ð°Ð¼Ð¶" },
      { en:"reset", mn:"reset" },
      { en:"places", mn:"Ñ…Ð°Ð°ÑˆÐ°Ð° Ð¾Ñ‡Ð¸Ñ…" },
      { en:"accommodation", mn:"Ð±Ð°Ð¹Ñ€Ð»Ð°Ñ… Ð³Ð°Ð·Ð°Ñ€" },
      { en:"weather", mn:"Ñ†Ð°Ð³ Ð°Ð³Ð°Ð°Ñ€" },
      { en:"transport", mn:"ÑƒÐ½Ð°Ð°" },
      { en:"safety", mn:"Ð°ÑŽÑƒÐ»Ð³Ò¯Ð¹" },
      { en:"cost", mn:"Ð·Ð°Ñ€Ð´Ð»Ñ‹Ð³ Ð·Ð°Ð´Ð°Ð»" },
      { en:"make itinerary", mn:"Ð°ÑÐ»Ð»Ñ‹Ð½ Ñ‚Ó©Ð»Ó©Ð²Ð»Ó©Ð³Ó©Ó©" },
    ];

    function renderChips(){
      const wrap = document.getElementById("chips");
      wrap.innerHTML = "";
      CHIP_DATA.forEach(c=>{
        const el = document.createElement("div");
        el.className = "chip";
        el.textContent = currentLang==="mn" ? c.mn : c.en;
        el.onclick = ()=>{
          const msg = currentLang==="mn" ? c.mn : c.en;
          handleSend(msg);
        };
        wrap.appendChild(el);
      });
    }

    // ==========================
    // Rasa send (supports rich messages)
    // ==========================
    async function sendToRasa(message){
      const sender = getActiveId(); // per-chat sender
      const res = await fetch(RASA_URL, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ sender, message })
      });
      if(!res.ok) throw new Error("Rasa error " + res.status);
      const data = await res.json();
      return Array.isArray(data) ? data : [];
    }

    function normalizeRasaMessages(msgs){
      // Convert any Rasa message objects to a consistent payload shape
      return msgs.map(m=>{
        const payload = {};
        if(typeof m === "string"){
          payload.text = m;
          return payload;
        }
        if(m.text) payload.text = m.text;
        if(m.image) payload.image = m.image;
        if(m.attachment) payload.attachment = m.attachment;
        if(m.buttons) payload.buttons = m.buttons;
        if(m.custom) payload.custom = m.custom;

        // Sometimes rasa sends "elements" (carousel) or "quick_replies"
        if(m.elements && !payload.custom) payload.custom = { elements: m.elements };
        if(m.quick_replies && !payload.custom) payload.custom = { quick_replies: m.quick_replies };

        // Fallback: store whole object
        if(!payload.text && !payload.image && !payload.attachment && !payload.buttons && !payload.custom){
          payload.custom = m;
        }
        return payload;
      });
    }

    async function handleSend(raw){
      const msg = (raw||"").trim();
      if(!msg || isSending) return;

      const input = document.getElementById("messageInput");
      input.value = "";

      isSending = true;
      document.getElementById("sendBtn").disabled = true;

      try{
        addMessage("user", msg);
        setTyping(true);

        const repliesRaw = await sendToRasa(msg);
        const replies = normalizeRasaMessages(repliesRaw);

        setTyping(false);

        if(!replies.length){
          const fallback = "Ð£ÑƒÑ‡Ð»Ð°Ð°Ñ€Ð°Ð¹, Ð¾Ð¹Ð»Ð³Ð¾ÑÐ¾Ð½Ð³Ò¯Ð¹.||Sorry, I didnâ€™t get that.";
          addMessage("bot", fallback);
        } else {
          replies.forEach(p=>{
            // render & store payload
            addBotRichMessage(p);
            addBotPayloadToStorage(p);
          });
          renderHistory(document.getElementById("historySearch").value);
        }
      }catch(err){
        console.error(err);
        setTyping(false);
        showToast(t("toastRasa"));
        // UI fallback bot message (so user sees something)
        addMessage("bot", "Ð¡ÐµÑ€Ð²ÐµÑ€Ñ‚ÑÐ¹ Ñ…Ð¾Ð»Ð±Ð¾Ð³Ð´Ð¾Ð¶ Ñ‡Ð°Ð´ÑÐ°Ð½Ð³Ò¯Ð¹.||Could not reach the server.");
      }finally{
        isSending = false;
        document.getElementById("sendBtn").disabled = false;
      }
    }

    // ==========================
    // Voice to text (Web Speech API)
    // ==========================
    let recognition = null;
    let recOn = false;

    function initSTT(){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SR) return false;
      recognition = new SR();
      recognition.continuous = false;
      recognition.interimResults = false;

      recognition.onstart = ()=>{
        recOn = true;
        document.getElementById("micBtn").classList.add("rec");
      };
      recognition.onend = ()=>{
        recOn = false;
        document.getElementById("micBtn").classList.remove("rec");
      };
      recognition.onresult = (event)=>{
        const text = event.results?.[0]?.[0]?.transcript || "";
        const input = document.getElementById("messageInput");
        input.value = text;
        input.focus();
      };
      recognition.onerror = ()=>{
        showToast(currentLang==="mn" ? "Voice-to-text Ð°Ð¶Ð¸Ð»Ð»Ð°Ñ…Ð³Ò¯Ð¹ Ð±Ð°Ð¹Ð½Ð°." : "Voice-to-text not available.");
      };
      return true;
    }

    function startSTT(){
      if(!recognition && !initSTT()){
        showToast(currentLang==="mn" ? "Ð¢Ð°Ð½Ñ‹ browser voice-to-text Ð´ÑÐ¼Ð¶Ð¸Ñ…Ð³Ò¯Ð¹." : "Your browser doesnâ€™t support voice-to-text.");
        return;
      }
      if(recOn){
        try{ recognition.stop(); }catch{}
        return;
      }
      recognition.lang = (currentLang==="mn") ? "mn-MN" : "en-US";
      recognition.start();
    }

    // ==========================
    // Auth modal
    // ==========================
    const authModal = document.getElementById("authModalBackdrop");
    function openAuthModal(type){
      document.getElementById("authModalTitle").textContent = type==="in" ? t("modalInTitle") : t("modalUpTitle");
      document.getElementById("authModalText").textContent = t("modalText");
      authModal.style.display = "flex";
    }
    function closeAuthModal(){ authModal.style.display="none"; }

    // ==========================
    // Confirm modal (Delete/Clear)
    // ==========================
    const confirmModal = document.getElementById("confirmBackdrop");
    let confirmAction = null;

    function openConfirm({title, text, okText, onOk}){
      document.getElementById("confirmTitle").textContent = title || t("confirmTitle");
      document.getElementById("confirmText").textContent = text || "";
      document.getElementById("confirmCancel").textContent = t("cancel");
      document.getElementById("confirmOk").textContent = okText || t("del");
      confirmAction = onOk;
      confirmModal.style.display = "flex";
    }
    function closeConfirm(){ confirmModal.style.display="none"; confirmAction = null; }

    function confirmDeleteChat(id){
      openConfirm({
        title: t("confirmTitle"),
        text: t("confirmChat"),
        okText: t("del"),
        onOk: ()=> deleteChatNow(id)
      });
    }
    function confirmClearAll(){
      openConfirm({
        title: t("confirmTitle"),
        text: t("confirmAll"),
        okText: t("clear"),
        onOk: ()=> clearAllChatsNow()
      });
    }

    // ==========================
    // Init / Bind
    // ==========================
    window.addEventListener("load", ()=>{
      ensureChat(getActiveId());
      renderHistory();
      renderChips();

      // Default EN
      currentLang = "en";
      document.getElementById("btnEN").classList.add("active");
      document.getElementById("btnMN").classList.remove("active");
      applyI18n();

      // Welcome if empty
      const active = getActiveChat();
      if(!active || !active.messages || !active.messages.length){
        addMessage("bot", `${t("welcome")}||${t("welcome")}`);
      } else {
        renderChatFromStorage();
      }

      const input = document.getElementById("messageInput");

      document.getElementById("sendBtn").onclick = ()=> handleSend(input.value);

      input.addEventListener("keydown", (e)=>{
        if(e.key==="Enter" && !e.shiftKey){
          e.preventDefault();
          handleSend(input.value);
        }
      });

      document.getElementById("micBtn").onclick = startSTT;

      document.getElementById("historySearch").addEventListener("input", (e)=>renderHistory(e.target.value));
      document.getElementById("newChatBtn").onclick = ()=>newChat();

      // Clear all -> confirm
      document.getElementById("clearAllBtn").onclick = ()=>confirmClearAll();

      document.getElementById("btnMN").onclick = ()=>{
        currentLang = "mn";
        document.getElementById("btnMN").classList.add("active");
        document.getElementById("btnEN").classList.remove("active");
        applyI18n();
      };
      document.getElementById("btnEN").onclick = ()=>{
        currentLang = "en";
        document.getElementById("btnEN").classList.add("active");
        document.getElementById("btnMN").classList.remove("active");
        applyI18n();
      };

      document.getElementById("signInBtn").onclick = ()=>openAuthModal("in");
      document.getElementById("signUpBtn").onclick = ()=>openAuthModal("up");
      document.getElementById("authModalClose").onclick = closeAuthModal;
      authModal.addEventListener("click", (e)=>{ if(e.target===authModal) closeAuthModal(); });

      // Confirm modal events
      document.getElementById("confirmClose").onclick = closeConfirm;
      document.getElementById("confirmCancel").onclick = closeConfirm;
      document.getElementById("confirmOk").onclick = ()=>{
        const fn = confirmAction;
        closeConfirm();
        if(typeof fn === "function") fn();
        renderHistory(document.getElementById("historySearch").value);
        renderChatFromStorage();
      };
      confirmModal.addEventListener("click", (e)=>{ if(e.target===confirmModal) closeConfirm(); });
    });
  </script>
</body>
</html>
