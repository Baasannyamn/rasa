<!doctype html>
<html lang="mn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–¢–∞–Ω—ã –∞—è–ª–∞–ª—ã–Ω —Ç—É—Å–ª–∞—Ö</title>
  <style>
    :root{
      --app-bg: #0b1020;
      --panel:  #0f1830;
      --panel2: #101a2e;
      --panel3: #0e1528;

      --ink:    #e9eefc;
      --muted:  rgba(233,238,252,.72);
      --muted2: rgba(233,238,252,.55);

      --stroke: rgba(255,255,255,.10);
      --stroke2: rgba(120,140,255,.35);
      --shadow: 0 10px 26px rgba(0,0,0,.35);

      --radius: 18px;
      --danger: rgba(255,80,120,.22);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
      color: var(--ink);
      background: var(--app-bg);
      overflow:hidden;
    }

    .app{ height:100%; display:flex; }

    /* ===== Sidebar ===== */
    .sidebar{
      width: 340px;
      height: 100%;
      padding: 14px;
      border-right: 1px solid rgba(255,255,255,0.08);
      background: var(--panel);
    }

    .sidebar-top{
      display:flex;
      gap:10px;
      align-items:center;
    }

    .btn-newchat{
      flex: 1;
      display:flex;
      align-items:center;
      gap:10px;
      padding: 12px 14px;
      border-radius: 14px;
      border:1px solid var(--stroke);
      color: var(--ink);
      cursor:pointer;
      background: var(--panel2);
      box-shadow: var(--shadow);
      transition: transform .15s ease, border .15s ease;
    }
    .btn-newchat:hover{
      transform: translateY(-1px);
      border:1px solid var(--stroke2);
    }
    .plus{
      width: 28px; height: 28px;
      display:grid; place-items:center;
      border-radius: 10px;
      background: rgba(120,140,255,0.12);
      border:1px solid rgba(255,255,255,0.10);
      font-weight: 900;
    }

    .btn-clear{
      width: 44px;
      height: 44px;
      border-radius: 14px;
      border:1px solid var(--stroke);
      background: var(--panel2);
      color: var(--muted);
      cursor:pointer;
      box-shadow: var(--shadow);
      transition: transform .15s ease, border .15s ease, color .15s ease;
    }
    .btn-clear:hover{
      transform: translateY(-1px);
      border:1px solid rgba(255,100,140,0.35);
      color: var(--ink);
    }

    .sidebar-section-title{
      margin: 12px 4px 8px;
      font-size: 12px;
      letter-spacing: .12em;
      text-transform: uppercase;
      color: rgba(233,238,252,0.60);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .search{
      width:100%;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid var(--stroke);
      outline:none;
      background: var(--panel3);
      color: var(--ink);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.06);
    }
    .search::placeholder{ color: rgba(233,238,252,0.45); }

    .chat-history{
      margin-top: 10px;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:auto;
      padding-right:4px;
      max-height: calc(100vh - 190px);
    }
    .chat-history::-webkit-scrollbar{width:10px}
    .chat-history::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.12);border-radius:999px}

    .chat-card{
      padding: 12px 12px;
      border-radius: 16px;
      cursor:pointer;
      border:1px solid var(--stroke);
      background: var(--panel2);
      box-shadow: 0 10px 26px rgba(0,0,0,0.22), inset 0 1px 0 rgba(255,255,255,0.06);
      transition: transform .15s ease, border .15s ease, opacity .18s ease;
      position: relative;
      opacity: 1;
    }
    .chat-card:hover{
      transform: translateY(-1px);
      border:1px solid var(--stroke2);
    }
    .chat-card.active{
      border:1px solid rgba(120,140,255,0.55);
    }
    .chat-card.deleting{
      opacity: 0;
      transform: translateY(2px);
    }

    .chat-card-title{ font-weight:900; font-size:14px; margin-bottom:6px; padding-right:34px;}
    .chat-card-sub{ font-size:12px; color: rgba(233,238,252,0.72); line-height:1.35; padding-right:34px;}

    .chat-del{
      position:absolute;
      top:10px;
      right:10px;
      width: 26px; height:26px;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.05);
      color: rgba(233,238,252,0.70);
      display:grid; place-items:center;
      font-weight:900;
      cursor:pointer;
      transition: border .15s ease, color .15s ease, background .15s ease;
    }
    .chat-del:hover{
      border:1px solid rgba(255,100,140,0.40);
      color: var(--ink);
      background: rgba(255,80,120,0.12);
    }

    /* ===== Main ===== */
    .main{ flex:1; height:100%; display:flex; flex-direction:column; }

    .topbar{
      height: 64px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 0 18px;
      border-bottom:1px solid rgba(255,255,255,0.08);
      background: var(--panel);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight: 900;
      letter-spacing:.02em;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: rgba(120,140,255,0.85);
      box-shadow: 0 0 18px rgba(120,140,255,0.45);
    }

    .top-actions{
      display:flex;
      align-items:center;
      gap:10px;
      color: var(--muted);
      font-size: 14px;
    }

    .lang-wrap{
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
    }
    .lang-btn{
      cursor:pointer;
      border:none;
      color: var(--ink);
      background: rgba(120,140,255,0.12);
      border:1px solid rgba(255,255,255,0.10);
      padding: 6px 12px;
      border-radius:999px;
      font-weight: 900;
      transition: transform .15s ease, border .15s ease, background .15s ease;
    }
    .lang-btn:hover{
      transform: translateY(-1px);
      border:1px solid var(--stroke2);
      background: rgba(120,140,255,0.18);
    }
    .lang-btn.active{
      border:1px solid rgba(120,140,255,0.55);
      background: rgba(120,140,255,0.22);
    }

    .link-btn{
      cursor:pointer;
      border:none;
      color: var(--muted);
      background: transparent;
      padding: 6px 10px;
      border-radius: 10px;
    }
    .link-btn:hover{ background: rgba(255,255,255,0.05); color: var(--ink); }

    .content{
      flex:1;
      display:flex;
      justify-content:center;
      overflow:hidden;
    }
    .chat-wrap{
      width: min(1020px, calc(100% - 28px));
      height: 100%;
      display:flex;
      flex-direction:column;
      padding: 18px 0;
    }

    .welcome{
      text-align:center;
      margin: 22px 0 10px;
      font-size: 30px;
      font-weight: 900;
    }
    .sub{
      text-align:center;
      color: var(--muted2);
      margin-bottom: 14px;
      font-size: 13px;
    }

    .messages{
      flex:1;
      overflow:auto;
      padding: 0 10px 10px;
    }
    .messages::-webkit-scrollbar{width:10px}
    .messages::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.12);border-radius:999px}

    .msg{
      display:flex;
      gap:10px;
      margin: 10px 0;
      align-items:flex-end;
      width: 100%;
    }
    .msg.bot{ justify-content:flex-start; }
    .msg.user{ justify-content:flex-end; }

    .avatar{
      width: 34px; height: 34px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      display:grid;
      place-items:center;
      font-weight: 900;
      color: rgba(233,238,252,0.9);
      flex: 0 0 auto;
      overflow:hidden;
    }
    .avatar img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
    }

    .bubble{
      max-width: 76ch;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.06);
      line-height: 1.45;
      white-space: pre-wrap;
    }

    /* user bubble right + slightly different */
    .user .bubble{
      background: rgba(120,140,255,0.14);
      border: 1px solid rgba(120,140,255,0.28);
      border-top-right-radius: 8px;
    }
    .bot .bubble{
      border-top-left-radius: 8px;
    }

    /* Typing indicator */
    .typing{
      display:flex;
      align-items:center;
      gap:10px;
      margin: 10px 0;
      opacity: .9;
    }
    .typing .dots{
      display:flex;
      gap:6px;
      padding: 10px 14px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      width: fit-content;
    }
    .typing .dotx{
      width:7px; height:7px;
      border-radius:999px;
      background: rgba(233,238,252,0.75);
      animation: bounce 1.1s infinite ease-in-out;
    }
    .typing .dotx:nth-child(2){ animation-delay:.15s }
    .typing .dotx:nth-child(3){ animation-delay:.30s }
    @keyframes bounce{
      0%,80%,100%{transform: translateY(0); opacity:.55}
      40%{transform: translateY(-5px); opacity:1}
    }

    /* Composer */
    .composer{
      padding: 12px 10px 18px;
      border-top: 1px solid rgba(255,255,255,0.08);
      background: var(--panel);
    }
    .row{
      display:flex;
      gap:10px;
      align-items:flex-end;
    }
    textarea{
      flex:1;
      resize:none;
      min-height: 46px;
      max-height: 160px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: var(--panel3);
      color: var(--ink);
      outline: none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.06);
    }
    textarea:focus{ border: 1px solid rgba(120,140,255,0.40); }

    .btn{
      border:none;
      cursor:pointer;
      padding: 12px 14px;
      border-radius: 14px;
      color: var(--ink);
      font-weight: 900;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(120,140,255,0.16);
      box-shadow: var(--shadow);
      transition: transform .15s ease, border .15s ease, background .15s ease;
    }
    .btn:hover{
      transform: translateY(-1px);
      border:1px solid var(--stroke2);
      background: rgba(120,140,255,0.22);
    }

    /* Chips */
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      padding: 0 10px 10px;
    }
    .chip{
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      color: rgba(233,238,252,0.85);
      font-size: 12px;
      cursor:pointer;
      user-select:none;
    }
    .chip:hover{ border:1px solid rgba(120,140,255,0.35) }

    /* Toast */
    .toast{
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 9999;
      min-width: 260px;
      max-width: 380px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(20,26,60,0.95);
      box-shadow: 0 18px 40px rgba(0,0,0,.45);
      color: var(--ink);
      display:none;
    }
    .toast.show{display:block; animation: toastIn .18s ease;}
    @keyframes toastIn{from{transform:translateY(6px); opacity:0} to{transform:translateY(0); opacity:1}}
    .toast-title{font-weight:900; margin-bottom:4px}
    .toast-msg{color:rgba(233,238,252,.85); font-size:13px; line-height:1.35}

    /* ===== Modals ===== */
    .modal-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 9998;
      padding: 18px;
    }
    .modal-backdrop.show{ display:flex; }

    .modal{
      width: min(520px, 100%);
      background: rgba(16,26,46,0.98);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 18px;
      box-shadow: 0 24px 60px rgba(0,0,0,0.55);
      overflow:hidden;
      animation: pop .16s ease;
    }
    @keyframes pop{ from{transform: translateY(6px); opacity:0} to{transform: translateY(0); opacity:1} }
    .modal-hd{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 14px 14px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .modal-title{ font-weight: 900; }
    .modal-x{
      width: 36px; height: 36px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.05);
      color: var(--ink);
      cursor:pointer;
      display:grid; place-items:center;
      font-weight: 900;
    }
    .modal-bd{ padding: 14px; color: var(--muted); }
    .modal-row{ display:flex; gap:10px; margin-top:10px; }
    .input{
      width: 100%;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(12,18,36,0.85);
      color: var(--ink);
      outline: none;
    }
    .modal-actions{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      padding: 14px;
      border-top: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.02);
    }
    .btn-ghost{
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      color: var(--ink);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight: 900;
    }
    .btn-danger{
      border:1px solid rgba(255,80,120,0.30);
      background: var(--danger);
      color: var(--ink);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight: 900;
    }

    @media (max-width: 760px){
      body{ overflow:auto; }
      .app{ flex-direction: column; }
      .sidebar{
        width:100%;
        height:auto;
        border-right:none;
        border-bottom:1px solid rgba(255,255,255,0.08);
      }
      .chat-history{ max-height: 260px; }
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-top">
        <button id="btnNewChat" class="btn-newchat" type="button" title="New chat">
          <span class="plus">+</span>
          <span>New Chat</span>
        </button>

        <button id="btnClearAll" class="btn-clear" type="button" title="Clear all chats">üóëÔ∏è</button>
      </div>

      <div class="sidebar-section-title">
        <span>HISTORY</span>
        <span style="color:rgba(233,238,252,.45); font-size:12px;" id="historyCount"></span>
      </div>

      <input id="historySearch" class="search" placeholder="Search chats..." />

      <div id="chatHistory" class="chat-history"></div>
    </aside>

    <!-- Main -->
    <main class="main">
      <header class="topbar">
        <div class="brand">
          <span class="dot"></span>
          <span>–¢–∞–Ω—ã –∞—è–ª–∞–ª—ã–Ω —Ç—É—Å–ª–∞—Ö</span>
        </div>

        <div class="top-actions">
          <div class="lang-wrap" title="Language">
            <button id="btnMN" class="lang-btn" type="button">MN</button>
            <button id="btnEN" class="lang-btn" type="button">EN</button>
          </div>
          <button id="btnSignIn" class="link-btn" type="button">Sign in</button>
          <button id="btnSignUp" class="link-btn" type="button">Sign up</button>
        </div>
      </header>

      <div class="content">
        <div class="chat-wrap">
          <div class="welcome">–¢–∞–Ω—ã –∞—è–ª–∞–ª—ã–Ω —Ç—É—Å–ª–∞—Ö</div>
          <div class="sub">–ê—Å—É—É–ª—Ç–∞–∞ –±–∏—á—ç—ç—Ä—ç–π / Ask your question</div>

          <div id="messages" class="messages"></div>

          <div class="chips">
            <div class="chip" data-text="–∞—è–ª–∞–ª">–∞—è–ª–∞–ª</div>
            <div class="chip" data-text="—Ç—É—Å–ª–∞–º–∂">—Ç—É—Å–ª–∞–º–∂</div>
            <div class="chip" data-text="reset">reset</div>
            <div class="chip" data-text="—Ö–∞–∞—à–∞–∞ –æ—á–∏—Ö –≤—ç">—Ö–∞–∞—à–∞–∞ –æ—á–∏—Ö –≤—ç</div>
            <div class="chip" data-text="–±–∞–π—Ä–ª–∞—Ö –≥–∞–∑–∞—Ä">–±–∞–π—Ä–ª–∞—Ö –≥–∞–∑–∞—Ä</div>
            <div class="chip" data-text="—Ü–∞–≥ –∞–≥–∞–∞—Ä">—Ü–∞–≥ –∞–≥–∞–∞—Ä</div>
            <div class="chip" data-text="—É–Ω–∞–∞">—É–Ω–∞–∞</div>
            <div class="chip" data-text="–∞—é—É–ª–≥“Ø–π">–∞—é—É–ª–≥“Ø–π</div>
            <div class="chip" data-text="–∑–∞—Ä–¥–ª—ã–≥ –∑–∞–¥–∞–ª">–∑–∞—Ä–¥–ª—ã–≥ –∑–∞–¥–∞–ª</div>
          </div>

          <div class="composer">
            <div class="row">
              <textarea id="input" placeholder="Message... (Enter = send, Shift+Enter = newline)"></textarea>
              <button id="btnSend" class="btn" type="button">SEND</button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast">
    <div class="toast-title" id="toastTitle">Info</div>
    <div class="toast-msg" id="toastMsg">...</div>
  </div>

  <!-- Sign In Modal -->
  <div id="modalSignIn" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-hd">
        <div class="modal-title">Sign in</div>
        <button class="modal-x" data-close="modalSignIn" type="button">√ó</button>
      </div>
      <div class="modal-bd">
        <div>–≠–Ω–¥ –∂–∏—à—ç—ç form –±–∞–π–Ω–∞. (backend —Ö–æ–ª–±–æ—Ö–¥–æ–æ —ç–Ω–¥—ç—ç—Å “Ø—Ä–≥—ç–ª–∂–ª“Ø“Ø–ª–Ω—ç)</div>
        <div class="modal-row">
          <input class="input" id="signinEmail" placeholder="Email" />
        </div>
        <div class="modal-row">
          <input class="input" id="signinPass" type="password" placeholder="Password" />
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-ghost" data-close="modalSignIn" type="button">Cancel</button>
        <button class="btn" id="doSignIn" type="button">Continue</button>
      </div>
    </div>
  </div>

  <!-- Sign Up Modal -->
  <div id="modalSignUp" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-hd">
        <div class="modal-title">Sign up</div>
        <button class="modal-x" data-close="modalSignUp" type="button">√ó</button>
      </div>
      <div class="modal-bd">
        <div>–≠–Ω–¥ –∂–∏—à—ç—ç form –±–∞–π–Ω–∞. (backend —Ö–æ–ª–±–æ—Ö–¥–æ–æ —ç–Ω–¥—ç—ç—Å “Ø—Ä–≥—ç–ª–∂–ª“Ø“Ø–ª–Ω—ç)</div>
        <div class="modal-row">
          <input class="input" id="signupName" placeholder="Name" />
        </div>
        <div class="modal-row">
          <input class="input" id="signupEmail" placeholder="Email" />
        </div>
        <div class="modal-row">
          <input class="input" id="signupPass" type="password" placeholder="Password" />
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-ghost" data-close="modalSignUp" type="button">Cancel</button>
        <button class="btn" id="doSignUp" type="button">Create account</button>
      </div>
    </div>
  </div>

  <!-- Confirm Delete Modal -->
  <div id="modalConfirm" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-hd">
        <div class="modal-title">Confirm delete</div>
        <button class="modal-x" data-close="modalConfirm" type="button">√ó</button>
      </div>
      <div class="modal-bd" id="confirmText">Are you sure?</div>
      <div class="modal-actions">
        <button class="btn-ghost" data-close="modalConfirm" type="button">Cancel</button>
        <button class="btn-danger" id="confirmYes" type="button">Delete</button>
      </div>
    </div>
  </div>

  <script>
    // ====== Config ======
    const RASA_URL = "http://localhost:5005/webhooks/rest/webhook";
    const STORAGE_KEY = "muis_chat_history_v1";
    const LOGO_PATH = "logo.png"; // <- logo —Ñ–∞–π–ª–∞–∞ —ç–Ω—ç HTML-—Ç—ç–π –∞–¥–∏–ª —Ö–∞–≤—Ç—Å–∞–Ω–¥ —Ç–∞–≤—å

    // ====== Store ======
    function loadStore() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || { chats: [], activeId: null, lang: "mn" }; }
      catch { return { chats: [], activeId: null, lang: "mn" }; }
    }
    function saveStore(s) { localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }
    function uid() { return "chat_" + Date.now() + "_" + Math.random().toString(16).slice(2); }

    let store = loadStore();

    // ====== Elements ======
    const historyEl = document.getElementById("chatHistory");
    const btnNewChat = document.getElementById("btnNewChat");
    const btnClearAll = document.getElementById("btnClearAll");
    const historySearch = document.getElementById("historySearch");
    const historyCount = document.getElementById("historyCount");

    const messagesEl = document.getElementById("messages");
    const inputEl = document.getElementById("input");
    const btnSend = document.getElementById("btnSend");
    const btnMN = document.getElementById("btnMN");
    const btnEN = document.getElementById("btnEN");

    const btnSignIn = document.getElementById("btnSignIn");
    const btnSignUp = document.getElementById("btnSignUp");

    const toastEl = document.getElementById("toast");
    const toastTitleEl = document.getElementById("toastTitle");
    const toastMsgEl = document.getElementById("toastMsg");

    // modals
    const modalSignIn = document.getElementById("modalSignIn");
    const modalSignUp = document.getElementById("modalSignUp");
    const modalConfirm = document.getElementById("modalConfirm");
    const confirmText = document.getElementById("confirmText");
    const confirmYes = document.getElementById("confirmYes");

    // ====== Toast ======
    let toastTimer = null;
    function showToast(title, msg) {
      toastTitleEl.textContent = title || "Info";
      toastMsgEl.textContent = msg || "";
      toastEl.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => toastEl.classList.remove("show"), 2600);
    }

    // ====== Modal helpers ======
    function openModal(el){ el.classList.add("show"); el.setAttribute("aria-hidden","false"); }
    function closeModal(el){ el.classList.remove("show"); el.setAttribute("aria-hidden","true"); }

    document.querySelectorAll("[data-close]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-close");
        const el = document.getElementById(id);
        if (el) closeModal(el);
      });
    });
    [modalSignIn, modalSignUp, modalConfirm].forEach(backdrop=>{
      backdrop.addEventListener("click", (e)=>{
        if (e.target === backdrop) closeModal(backdrop);
      });
    });
    document.addEventListener("keydown",(e)=>{
      if(e.key==="Escape"){
        [modalSignIn, modalSignUp, modalConfirm].forEach(m=>m.classList.contains("show") && closeModal(m));
      }
    });

    // ====== Messages render ======
    function scrollToBottom() { messagesEl.scrollTop = messagesEl.scrollHeight; }

    function avatarNode(role){
      const av = document.createElement("div");
      av.className = "avatar";
      if (role === "bot"){
        const img = document.createElement("img");
        img.src = LOGO_PATH;
        img.alt = "AI";
        img.onerror = () => { av.textContent = "AI"; };
        av.appendChild(img);
      } else {
        av.textContent = "U";
      }
      return av;
    }

    function msgNode(role, text) {
      const wrap = document.createElement("div");
      wrap.className = "msg " + (role === "user" ? "user" : "bot");

      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.textContent = text;

      // user: bubble then avatar (–±–∞—Ä—É—É–Ω —Ç–∞–ª)
      if (role === "user"){
        wrap.appendChild(bubble);
        wrap.appendChild(avatarNode(role));
      } else {
        wrap.appendChild(avatarNode(role));
        wrap.appendChild(bubble);
      }

      return wrap;
    }

    function renderMessages(messages) {
      messagesEl.innerHTML = "";
      (messages || []).forEach(m => messagesEl.appendChild(msgNode(m.role, m.text)));
      scrollToBottom();
    }

    // ====== Typing indicator ======
    let typingEl = null;
    function showTyping() {
      if (typingEl) return;
      typingEl = document.createElement("div");
      typingEl.className = "typing";
      typingEl.innerHTML = `
        <div class="avatar"><img src="${LOGO_PATH}" onerror="this.parentNode.textContent='AI'" alt="AI"></div>
        <div class="dots" title="–±–æ—Ç –±–∏—á–∏–∂ –±–∞–π–Ω–∞‚Ä¶">
          <div class="dotx"></div><div class="dotx"></div><div class="dotx"></div>
        </div>
      `;
      messagesEl.appendChild(typingEl);
      scrollToBottom();
    }
    function hideTyping() {
      if (!typingEl) return;
      typingEl.remove();
      typingEl = null;
    }

    // ====== History helpers ======
    function ensureDefaultChat() {
      if (store.chats.length) return;

      const id = uid();
      const greet = "–°–∞–π–Ω –±–∞–π–Ω–∞ —É—É üëã\n–≠—Ö–ª—ç—Ö: ‚Äú–∞—è–ª–∞–ª‚Äù\n–¢—É—Å–ª–∞–º–∂: ‚Äú—Ç—É—Å–ª–∞–º–∂‚Äù\n–î–∞—Ö–∏–Ω —ç—Ö–ª—ç—Ö: ‚Äúreset‚Äù";

      store.chats = [{
        id,
        title: "New chat",
        preview: "–°–∞–π–Ω –±–∞–π–Ω–∞ —É—É üëã  –≠—Ö–ª—ç—Ö: ‚Äú–∞—è–ª–∞–ª‚Äù  –¢—É—Å–ª–∞–º–∂: ‚Äú—Ç—É—Å–ª–∞–º–∂‚Äù  –î–∞—Ö–∏–Ω —ç—Ö–ª—ç—Ö: ‚Äúreset‚Äù",
        messages: [{ role: "bot", text: greet }]
      }];
      store.activeId = id;
      saveStore(store);
    }

    function getActiveChat() {
      return store.chats.find(c => c.id === store.activeId) || null;
    }

    function renderHistory() {
      ensureDefaultChat();
      const q = (historySearch.value || "").trim().toLowerCase();

      historyEl.innerHTML = "";
      const filtered = store.chats.filter(chat => {
        if (!q) return true;
        const hay = ((chat.title || "") + " " + (chat.preview || "")).toLowerCase();
        return hay.includes(q);
      });

      historyCount.textContent = `${filtered.length}/${store.chats.length}`;

      filtered.forEach(chat => {
        const card = document.createElement("div");
        card.className = "chat-card" + (chat.id === store.activeId ? " active" : "");
        card.onclick = () => openChat(chat.id);

        const title = document.createElement("div");
        title.className = "chat-card-title";
        title.textContent = chat.title || "New chat";

        const sub = document.createElement("div");
        sub.className = "chat-card-sub";
        sub.textContent = chat.preview || "‚Äî";

        const del = document.createElement("div");
        del.className = "chat-del";
        del.title = "Delete this chat";
        del.textContent = "√ó";
        del.onclick = (e) => {
          e.stopPropagation();
          confirmDeleteChat(chat.id, card);
        };

        card.appendChild(title);
        card.appendChild(sub);
        card.appendChild(del);
        historyEl.appendChild(card);
      });
    }

    function openChat(id) {
      store.activeId = id;
      saveStore(store);
      renderHistory();

      const chat = store.chats.find(c => c.id === id);
      renderMessages(chat ? chat.messages : []);
    }

    function createNewChat() {
      const id = uid();
      const greet = "–°–∞–π–Ω –±–∞–π–Ω–∞ —É—É üëã\n–≠—Ö–ª—ç—Ö: ‚Äú–∞—è–ª–∞–ª‚Äù\n–¢—É—Å–ª–∞–º–∂: ‚Äú—Ç—É—Å–ª–∞–º–∂‚Äù\n–î–∞—Ö–∏–Ω —ç—Ö–ª—ç—Ö: ‚Äúreset‚Äù";
      const chat = {
        id,
        title: "New chat",
        preview: "–°–∞–π–Ω –±–∞–π–Ω–∞ —É—É üëã  –≠—Ö–ª—ç—Ö: ‚Äú–∞—è–ª–∞–ª‚Äù  –¢—É—Å–ª–∞–º–∂: ‚Äú—Ç—É—Å–ª–∞–º–∂‚Äù  –î–∞—Ö–∏–Ω —ç—Ö–ª—ç—Ö: ‚Äúreset‚Äù",
        messages: [{ role: "bot", text: greet }]
      };
      store.chats.unshift(chat);
      store.activeId = id;
      saveStore(store);

      renderHistory();
      renderMessages(chat.messages);
    }

    function updateChatMetaAfterMessage(userText) {
      const chat = getActiveChat();
      if (!chat) return;

      if (chat.title === "New chat") {
        chat.title = userText.slice(0, 22) + (userText.length > 22 ? "‚Ä¶" : "");
      }
      chat.preview = userText.slice(0, 60) + (userText.length > 60 ? "‚Ä¶" : "");
      saveStore(store);
      renderHistory();
    }

    // ====== Delete flows (nice) ======
    let pendingDelete = null; // {id, cardEl, type}
    function confirmDeleteChat(id, cardEl){
      pendingDelete = { type:"one", id, cardEl };
      confirmText.textContent = "–≠–Ω—ç —á–∞—Ç—ã–≥ —É—Å—Ç–≥–∞—Ö —É—É? (history-–æ–æ—Å –±“Ø—Ä –º”©—Å”©–Ω –∞–ª–≥–∞ –±–æ–ª–Ω–æ)";
      openModal(modalConfirm);
    }
    function confirmClearAll(){
      pendingDelete = { type:"all" };
      confirmText.textContent = "–ë“Ø—Ö —á–∞—Ç–Ω—ã —Ç“Ø“Ø—Ö–∏–π–≥ —É—Å—Ç–≥–∞—Ö —É—É? (–±—É—Ü–∞–∞–∂ —Å—ç—Ä–≥—ç—ç—Ö –±–æ–ª–æ–º–∂–≥“Ø–π)";
      openModal(modalConfirm);
    }

    function deleteChatNow(id, cardEl){
      // animation
      if (cardEl) cardEl.classList.add("deleting");

      setTimeout(()=>{
        const idx = store.chats.findIndex(c => c.id === id);
        if (idx !== -1) store.chats.splice(idx, 1);

        if (!store.chats.length) {
          store.activeId = null;
          saveStore(store);
          ensureDefaultChat();
        } else if (store.activeId === id) {
          store.activeId = store.chats[0].id;
        }

        saveStore(store);
        renderHistory();
        openChat(store.activeId);
        showToast("Done", "Chat deleted.");
      }, 170);
    }

    function clearAllNow(){
      // soft clear animation: remove cards visually
      [...document.querySelectorAll(".chat-card")].forEach((c,i)=>{
        setTimeout(()=>c.classList.add("deleting"), i*18);
      });
      setTimeout(()=>{
        store.chats = [];
        store.activeId = null;
        saveStore(store);
        ensureDefaultChat();
        renderHistory();
        openChat(store.activeId);
        showToast("Done", "All chats cleared.");
      }, 260);
    }

    confirmYes.addEventListener("click", ()=>{
      closeModal(modalConfirm);
      if (!pendingDelete) return;

      if (pendingDelete.type === "one"){
        deleteChatNow(pendingDelete.id, pendingDelete.cardEl);
      } else {
        clearAllNow();
      }
      pendingDelete = null;
    });

    // ====== Rasa call ======
    async function sendToRasa(text) {
      const res = await fetch(RASA_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ sender: store.activeId || "web_user", message: text })
      });
      if (!res.ok) throw new Error("HTTP " + res.status);
      return await res.json();
    }

    // ====== Send message (normal) ======
    async function handleSend(text) {
      const userText = (text ?? inputEl.value).trim();
      if (!userText) return;

      ensureDefaultChat();
      const chat = getActiveChat();
      if (!chat) return;

      chat.messages.push({ role: "user", text: userText });
      updateChatMetaAfterMessage(userText);
      saveStore(store);
      renderMessages(chat.messages);

      inputEl.value = "";
      inputEl.style.height = "46px";

      showTyping();
      try {
        const data = await sendToRasa(userText);
        hideTyping();

        if (!Array.isArray(data) || data.length === 0) {
          chat.messages.push({ role: "bot", text: "‚Ä¶" });
        } else {
          data.forEach(item => { if (item.text) chat.messages.push({ role: "bot", text: item.text }); });
        }
        saveStore(store);
        renderMessages(chat.messages);
      } catch (e) {
        hideTyping();
        showToast("–ê–ª–¥–∞–∞ / Error", "Rasa —Å–µ—Ä–≤–µ—Ä –∞—Å–∞–∞–ª—Ç—Ç–∞–π —é—É? localhost:5005 (CORS –∑”©–≤ —ç—Å—ç—Ö—ç—ç —à–∞–ª–≥–∞)");
        console.error(e);
      }
    }

    // ====== Silent command (language) ======
    async function silentCommandToRasa(commandText) {
      try { await sendToRasa(commandText); }
      catch (e) {
        showToast("–ê–ª–¥–∞–∞ / Error", "Rasa-—Ç command –∏–ª–≥—ç—ç–∂ —á–∞–¥—Å–∞–Ω–≥“Ø–π. –°–µ—Ä–≤–µ—Ä –∞—Å–∞–∞–ª—Ç—Ç–∞–π —é—É?");
        console.error(e);
      }
    }

    function markLangButtons(){
      btnMN.classList.toggle("active", store.lang === "mn");
      btnEN.classList.toggle("active", store.lang === "en");
    }

    async function setLanguage(lang) {
      store.lang = lang;
      saveStore(store);
      markLangButtons();
      await silentCommandToRasa(`/set_language{"lang":"${lang}"}`);
      showToast("Language", lang === "mn" ? "–ú–æ–Ω–≥–æ–ª —Ö—ç–ª" : "English");
    }

    // ====== Events ======
    btnNewChat.addEventListener("click", createNewChat);
    btnClearAll.addEventListener("click", confirmClearAll);

    btnSend.addEventListener("click", () => handleSend());
    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });
    inputEl.addEventListener("input", () => {
      inputEl.style.height = "46px";
      inputEl.style.height = Math.min(inputEl.scrollHeight, 160) + "px";
    });

    historySearch.addEventListener("input", renderHistory);
    document.querySelectorAll(".chip").forEach(ch => {
      ch.addEventListener("click", () => handleSend(ch.dataset.text));
    });

    btnMN.addEventListener("click", () => setLanguage("mn"));
    btnEN.addEventListener("click", () => setLanguage("en"));

    // Sign in/up click => modal open
    btnSignIn.addEventListener("click", () => openModal(modalSignIn));
    btnSignUp.addEventListener("click", () => openModal(modalSignUp));

    // Demo actions
    document.getElementById("doSignIn").addEventListener("click", ()=>{
      closeModal(modalSignIn);
      showToast("Sign in", "Demo form. Backend —Ö–æ–ª–±–æ—Ö–¥–æ–æ —ç–Ω–¥—ç—ç—Å “Ø—Ä–≥—ç–ª–∂–ª“Ø“Ø–ª–Ω—ç.");
    });
    document.getElementById("doSignUp").addEventListener("click", ()=>{
      closeModal(modalSignUp);
      showToast("Sign up", "Demo form. Backend —Ö–æ–ª–±–æ—Ö–¥–æ–æ —ç–Ω–¥—ç—ç—Å “Ø—Ä–≥—ç–ª–∂–ª“Ø“Ø–ª–Ω—ç.");
    });

    // ====== Boot ======
    ensureDefaultChat();
    renderHistory();
    openChat(store.activeId);

    // init language button state
    markLangButtons();
  </script>
</body>
</html>
