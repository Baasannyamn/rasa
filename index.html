<!doctype html>
<html lang="mn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MUIS AI Assistant</title>

  <style>
    :root{
      /* Dark Navy theme (—Ö–∞—Ä-—Ö”©—Ö) */
      --bg0:#05070c;
      --bg1:#070a12;
      --panel:#0b0f1a;
      --panel2:#0f1526;
      --line:rgba(255,255,255,.08);
      --line2:rgba(255,255,255,.14);
      --text:#e9eefc;
      --muted:rgba(233,238,252,.72);
      --muted2:rgba(233,238,252,.52);

      --accent:#4b6bff;
      --accent2:#8aa0ff;
      --ok:#37d67a;
      --warn:#ffcc66;
      --err:#ff5c77;

      --shadow: 0 12px 40px rgba(0,0,0,.55);
      --shadowSoft: 0 0 15px rgba(255,255,255,0.10);
      --radius:18px;
      --radius2:14px;
      --pill:999px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans";
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 50% 18%, rgba(75,107,255,.22), transparent 55%),
        radial-gradient(900px 700px at 20% 30%, rgba(255,255,255,.06), transparent 55%),
        radial-gradient(900px 700px at 80% 30%, rgba(255,255,255,.05), transparent 55%),
        var(--bg0);
      overflow:hidden;
    }

    .app{
      height:100%;
      display:flex;
      gap:14px;
      padding:12px;
    }

    /* ===== Sidebar ===== */
    .sidebar{
      width:270px;
      min-width:250px;
      background: linear-gradient(180deg, rgba(11,15,26,.96), rgba(7,10,18,.92));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .sb-top{
      padding:14px 14px 10px;
      display:flex;
      align-items:center;
      gap:10px;
      border-bottom:1px solid var(--line);
    }
    .brand-dot{
      width:12px;height:12px;border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #ffffff, var(--accent) 55%, #2231a8);
      box-shadow: 0 0 16px rgba(75,107,255,.45);
    }
    .brand{ font-weight:800; letter-spacing:.2px; font-size:14px; }

    .sb-actions{
      padding:12px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .btn{
      appearance:none;
      border:1px solid var(--line2);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      cursor:pointer;
      text-align:left;
      display:flex;
      gap:10px;
      align-items:center;
      font-weight:700;
      transition:.16s ease;
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
    }
    .btn:hover{ filter:brightness(1.1); transform: translateY(-1px); }
    .btn:active{ transform: translateY(0px); }
    .btn .icon{
      width:20px;height:20px; display:grid; place-items:center;
      border-radius:10px;
      background: rgba(75,107,255,.12);
      border:1px solid rgba(75,107,255,.26);
      color:var(--accent2);
      font-size:12px;
      font-weight:900;
    }
    .sb-history{
      padding:0 14px 14px;
      overflow:auto;
      flex:1;
    }
    .history-card{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      padding:12px 12px;
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
      box-shadow: var(--shadowSoft);
    }
    .history-card b{ color:var(--text); }

    /* ===== Main ===== */
    .main{
      flex:1;
      min-width:0;
      background: linear-gradient(180deg, rgba(9,12,22,.80), rgba(7,10,18,.60));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      position:relative;
    }

    .topbar{
      height:54px;
      padding:10px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.12);
      backdrop-filter: blur(8px);
    }
    .top-left{
      display:flex;
      align-items:center;
      gap:10px;
      color:var(--muted2);
      font-size:12px;
      font-weight:800;
    }
    .status-dot{
      width:8px;height:8px;border-radius:50%;
      background: rgba(55,214,122,.9);
      box-shadow: 0 0 10px rgba(55,214,122,.25);
    }
    .top-right{
      display:flex;
      align-items:center;
      gap:10px;
    }

    .pill{
      border:1px solid var(--line2);
      background: rgba(255,255,255,.05);
      color: var(--text);
      border-radius: var(--pill);
      padding:6px 10px;
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      transition:.16s ease;
      user-select:none;
    }
    .pill:hover{ filter:brightness(1.12); transform: translateY(-1px); }
    .pill:active{ transform: translateY(0); }
    .pill.active{
      border-color: rgba(75,107,255,.55);
      background: rgba(75,107,255,.14);
      color: var(--accent2);
      box-shadow: 0 0 0 3px rgba(75,107,255,.12);
    }

    .link{
      color: var(--muted);
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      padding:6px 10px;
      border-radius: var(--pill);
      border:1px solid transparent;
      transition:.16s ease;
      user-select:none;
    }
    .link:hover{
      color:var(--text);
      border-color: var(--line2);
      background: rgba(255,255,255,.04);
      transform: translateY(-1px);
    }
    .link:active{ transform: translateY(0); }

    .hero{
      padding:28px 16px 14px;
      text-align:center;
    }
    .hero h1{
      margin:0;
      font-size:26px;
      letter-spacing:.2px;
      font-weight:900;
      text-shadow: 0 10px 40px rgba(0,0,0,.6);
    }
    .hero p{
      margin:8px 0 0;
      color:var(--muted);
      font-size:12px;
    }

    .chat{
      flex:1;
      overflow:auto;
      padding: 8px 16px 156px; /* bottom fixed —Ö—ç—Å—ç–≥—Ç –∑–∞–π */
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .msg{
      max-width: 560px;
      border-radius: 16px;
      padding:10px 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      box-shadow: var(--shadowSoft);
      font-size:13px;
      line-height:1.35;
      white-space:pre-wrap;
    }
    .msg.bot{ align-self:flex-start; }
    .msg.me{
      align-self:flex-end;
      background: rgba(75,107,255,.14);
      border-color: rgba(75,107,255,.26);
    }

    /* Typing indicator bubble */
    .typing{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      box-shadow: var(--shadowSoft);
      max-width: 320px;
      align-self:flex-start;
      color: var(--muted);
      font-size:13px;
    }
    .dots{
      display:flex; gap:6px; align-items:center;
    }
    .dot{
      width:7px;height:7px;border-radius:50%;
      background: rgba(233,238,252,.55);
      animation: bounce 1.1s infinite;
    }
    .dot:nth-child(2){ animation-delay: .12s; }
    .dot:nth-child(3){ animation-delay: .24s; }
    @keyframes bounce{
      0%,100%{ transform: translateY(0); opacity:.55; }
      50%{ transform: translateY(-4px); opacity:1; }
    }

    /* ===== Bottom fixed ===== */
    .bottom{
      position:absolute;
      left:0; right:0; bottom:0;
      padding:12px 14px 14px;
      border-top:1px solid var(--line);
      background: rgba(0,0,0,.20);
      backdrop-filter: blur(10px);
    }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      padding: 0 0 10px;
    }
    .chip{
      font-size:12px;
      color:var(--muted);
      background: rgba(15,21,38,.70);
      border:1px solid var(--line);
      border-radius: var(--pill);
      padding:8px 10px;
      cursor:pointer;
      transition:.15s ease;
      user-select:none;
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
    }
    .chip:hover{
      background: rgba(18,27,52,.78);
      color: var(--text);
      border-color: rgba(75,107,255,.28);
      box-shadow: 0 0 0 3px rgba(75,107,255,.10), 0 12px 30px rgba(0,0,0,.35);
      transform: translateY(-1px);
    }
    .chip:active{ transform: translateY(0); }

    .composer{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .mic{
      width:46px;
      height:44px;
      display:grid;
      place-items:center;
      border-radius: 14px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.05);
      cursor:pointer;
      transition:.16s ease;
      font-weight:900;
      user-select:none;
    }
    .mic:hover{ transform: translateY(-1px); filter:brightness(1.12); }
    .mic.rec{
      border-color: rgba(138,160,255,.55);
      box-shadow: 0 0 0 3px rgba(75,107,255,.14);
    }

    .input{
      flex:1;
      min-width:0;
      border-radius: 14px;
      border:1px solid var(--line2);
      background: rgba(15,21,38,.70);
      color: var(--text);
      padding: 12px 12px;
      outline:none;
      font-size:13px;
    }
    .input::placeholder{ color: rgba(233,238,252,.40); }

    .send{
      border-radius: 14px;
      border:1px solid rgba(75,107,255,.40);
      background: linear-gradient(180deg, rgba(75,107,255,.35), rgba(75,107,255,.18));
      color: var(--text);
      font-weight:900;
      padding: 12px 14px;
      cursor:pointer;
      transition:.16s ease;
      letter-spacing:.3px;
      user-select:none;
    }
    .send:hover{ filter:brightness(1.15); transform: translateY(-1px); }
    .send:active{ transform: translateY(0); }

    .footnote{
      margin-top:8px;
      font-size:11px;
      color: rgba(233,238,252,.45);
      display:flex;
      justify-content:space-between;
      gap:10px;
    }

    @media (max-width: 920px){
      .sidebar{ display:none; }
      .app{ padding:10px; }
      .chat{ padding: 8px 14px 170px; }
    }

    /* ===== Toast ===== */
    .toasts{
      position:fixed;
      right:16px;
      bottom:16px;
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index:9999;
      pointer-events:none;
    }
    .toast{
      width:320px;
      max-width: calc(100vw - 32px);
      border-radius: 14px;
      border:1px solid var(--line2);
      background: rgba(15,21,38,.88);
      box-shadow: var(--shadow);
      padding:10px 12px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      pointer-events:auto;
      animation: toastIn .2s ease;
      backdrop-filter: blur(10px);
    }
    @keyframes toastIn{
      from{ transform: translateY(6px); opacity:0; }
      to{ transform: translateY(0); opacity:1; }
    }
    .toast .badge{
      width:26px;height:26px;
      border-radius: 10px;
      display:grid; place-items:center;
      font-weight:900;
      color:var(--text);
      flex:0 0 auto;
    }
    .toast.error .badge{ background: rgba(255,92,119,.18); border:1px solid rgba(255,92,119,.35); color: var(--err); }
    .toast.ok .badge{ background: rgba(55,214,122,.16); border:1px solid rgba(55,214,122,.30); color: var(--ok); }
    .toast.warn .badge{ background: rgba(255,204,102,.14); border:1px solid rgba(255,204,102,.30); color: var(--warn); }

    .toast .content{ flex:1; min-width:0; }
    .toast .title{ font-weight:900; font-size:12px; color:var(--text); }
    .toast .desc{ margin-top:3px; font-size:12px; color:var(--muted); line-height:1.35; }
    .toast .close{
      border:none;
      background: transparent;
      color: rgba(233,238,252,.65);
      cursor:pointer;
      font-weight:900;
      padding:0 4px;
      line-height:1;
    }
    .toast .close:hover{ color: var(--text); }

    /* ===== Modal (Sign in/up) ===== */
    .modal-overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9998;
      padding:16px;
    }
    .modal{
      width:420px;
      max-width: 100%;
      border-radius: 18px;
      border:1px solid var(--line2);
      background: rgba(15,21,38,.92);
      box-shadow: var(--shadow);
      overflow:hidden;
      transform: translateY(6px);
      animation: pop .22s ease forwards;
    }
    @keyframes pop{
      to{ transform: translateY(0); }
    }
    .modal-head{
      padding:14px 14px 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.12);
    }
    .modal-title{
      font-weight:900;
      letter-spacing:.2px;
      font-size:14px;
    }
    .modal-close{
      border:1px solid var(--line2);
      background: rgba(255,255,255,.05);
      color: var(--text);
      border-radius: 12px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:900;
    }
    .modal-close:hover{ filter:brightness(1.1); }
    .modal-body{
      padding:14px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-bottom:10px;
    }
    .label{
      font-size:12px;
      color: var(--muted);
      font-weight:800;
    }
    .control{
      border-radius: 14px;
      border:1px solid var(--line2);
      background: rgba(11,15,26,.75);
      color: var(--text);
      padding:12px 12px;
      outline:none;
      font-size:13px;
    }
    .control::placeholder{ color: rgba(233,238,252,.40); }

    .modal-actions{
      display:flex;
      gap:10px;
      margin-top:10px;
    }
    .primary{
      flex:1;
      border-radius: 14px;
      border:1px solid rgba(75,107,255,.40);
      background: linear-gradient(180deg, rgba(75,107,255,.35), rgba(75,107,255,.18));
      color: var(--text);
      font-weight:900;
      padding:12px 14px;
      cursor:pointer;
    }
    .primary:hover{ filter:brightness(1.15); }
    .secondary{
      border-radius: 14px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.05);
      color: var(--text);
      font-weight:900;
      padding:12px 14px;
      cursor:pointer;
    }
    .secondary:hover{ filter:brightness(1.1); }

    .hint{
      margin-top:10px;
      font-size:12px;
      color: var(--muted2);
      line-height:1.35;
    }
    .hint a{
      color: var(--accent2);
      text-decoration:none;
      font-weight:900;
      cursor:pointer;
    }
    .hint a:hover{ text-decoration:underline; }

  </style>
</head>

<body>
  <div class="app">

    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sb-top">
        <div class="brand-dot"></div>
        <div class="brand">MUIS AI Assistant</div>
      </div>

      <div class="sb-actions">
        <button class="btn" id="newChatBtn">
          <span class="icon">Ôºã</span>
          <span>New Chat</span>
        </button>
        <button class="btn" id="newChatBtn2">
          <span class="icon">Ôºã</span>
          <span>New chat</span>
        </button>
      </div>

      <div class="sb-history">
        <div class="history-card" id="helpCard">
          <b>–°–∞–π–Ω –±–∞–π–Ω–∞ —É—É üëã</b><br/>
          –≠—Ö–ª—ç—Ö: <b>"–∞—è–ª–∞–ª"</b><br/>
          –¢—É—Å–ª–∞–º–∂: <b>"—Ç—É—Å–ª–∞–º–∂"</b><br/>
          –î–∞—Ö–∏–Ω —ç—Ö–ª—ç—Ö: <b>"reset"</b>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">

      <div class="topbar">
        <div class="top-left">
          <span class="status-dot"></span>
          <span id="statusText">Ready</span>
        </div>

        <div class="top-right">
          <div class="pill active" id="mnPill">MN</div>
          <div class="pill" id="enPill">EN</div>
          <div class="link" id="signIn">Sign in</div>
          <div class="link" id="signUp">Sign up</div>
        </div>
      </div>

      <div class="hero">
        <h1 id="heroTitle">Welcome to MUIS AI Assistant</h1>
        <p id="heroSub">–ê—Å—É—É–ª—Ç–∞–∞ –±–∏—á—ç—ç—Ä—ç–π</p>
      </div>

      <div class="chat" id="chat">
        <div class="msg bot" id="firstMsg">–°–∞–π–Ω –±–∞–π–Ω–∞ —É—É üëã ‚Äú–∞—è–ª–∞–ª‚Äù –≥—ç–∂ –±–∏—á–≤—ç–ª —Ç”©–ª”©–≤–ª”©–∂ —ç—Ö—ç–ª–Ω—ç.</div>
      </div>

      <div class="bottom">
        <div class="chips" id="suggest"></div>

        <div class="composer">
          <div class="mic" id="micBtn" title="Voice to Text">üé§</div>
          <input class="input" id="text" placeholder="–≠–Ω–¥ –±–∏—á—ç—ç—Ä—ç–π..." />
          <button class="send" id="send">SEND</button>
        </div>

        <div class="footnote">
          <div id="statusLeft">Rasa REST: http://localhost:5005/webhooks/rest/webhook</div>
          <div id="modeText">Ready</div>
        </div>
      </div>

    </main>
  </div>

  <!-- Toast container -->
  <div class="toasts" id="toasts"></div>

  <!-- Modal -->
  <div class="modal-overlay" id="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Auth modal">
      <div class="modal-head">
        <div class="modal-title" id="modalTitle">Sign in</div>
        <button class="modal-close" id="modalClose">Close</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <div class="label" id="labelEmail">Email</div>
          <input class="control" id="email" placeholder="you@example.com" />
        </div>
        <div class="field">
          <div class="label" id="labelPass">Password</div>
          <input class="control" id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>

        <div class="field" id="nameField" style="display:none;">
          <div class="label" id="labelName">Full name</div>
          <input class="control" id="fullname" placeholder="Your name" />
        </div>

        <div class="modal-actions">
          <button class="primary" id="modalPrimary">Continue</button>
          <button class="secondary" id="modalSecondary">Cancel</button>
        </div>

        <div class="hint" id="modalHint">
          Demo UI. Backend —Ö–æ–ª–±–æ–æ–≥“Ø–π –±–æ–ª login –±“Ø—Ä—Ç–≥—ç–ª —Ö–∏–π—Ö–≥“Ø–π, –∑”©–≤—Ö”©–Ω –∑–∞–≥–≤–∞—Ä —Ö–∞—Ä–∞–≥–¥–∞–Ω–∞.
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== Config =====
    const RASA_URL = "http://localhost:5005/webhooks/rest/webhook";
    const senderId = "web_user_" + Math.random().toString(16).slice(2);

    // ===== Elements =====
    const chat = document.getElementById("chat");
    const text = document.getElementById("text");
    const sendBtn = document.getElementById("send");
    const micBtn = document.getElementById("micBtn");
    const mnPill = document.getElementById("mnPill");
    const enPill = document.getElementById("enPill");
    const heroSub = document.getElementById("heroSub");
    const suggest = document.getElementById("suggest");
    const statusText = document.getElementById("statusText");
    const modeText = document.getElementById("modeText");

    const toasts = document.getElementById("toasts");

    // Modal
    const modalOverlay = document.getElementById("modalOverlay");
    const modalTitle = document.getElementById("modalTitle");
    const modalClose = document.getElementById("modalClose");
    const modalPrimary = document.getElementById("modalPrimary");
    const modalSecondary = document.getElementById("modalSecondary");
    const signInBtn = document.getElementById("signIn");
    const signUpBtn = document.getElementById("signUp");
    const nameField = document.getElementById("nameField");
    const labelEmail = document.getElementById("labelEmail");
    const labelPass = document.getElementById("labelPass");
    const labelName = document.getElementById("labelName");
    const modalHint = document.getElementById("modalHint");

    let lang = "mn";
    let authMode = "signin"; // signin | signup
    let typingEl = null;

    // ===== Helpers =====
    function addMsg(who, msg) {
      const d = document.createElement("div");
      d.className = "msg " + (who === "me" ? "me" : "bot");
      d.textContent = msg;
      chat.appendChild(d);
      chat.scrollTop = chat.scrollHeight;
    }

    function showTyping(show){
      if(show){
        if(typingEl) return;
        typingEl = document.createElement("div");
        typingEl.className = "typing";
        typingEl.innerHTML = `
          <div class="dots">
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
          </div>
          <div>${lang==="mn" ? "–ë–æ—Ç –±–∏—á–∏–∂ –±–∞–π–Ω–∞‚Ä¶" : "Typing‚Ä¶"}</div>
        `;
        chat.appendChild(typingEl);
        chat.scrollTop = chat.scrollHeight;
      } else {
        if(typingEl){
          typingEl.remove();
          typingEl = null;
        }
      }
    }

    function toast(type, title, desc, ms=3500){
      const t = document.createElement("div");
      t.className = "toast " + type;

      const badge = type==="error" ? "!" : (type==="ok" ? "‚úì" : "i");
      t.innerHTML = `
        <div class="badge">${badge}</div>
        <div class="content">
          <div class="title">${title}</div>
          <div class="desc">${desc}</div>
        </div>
        <button class="close" aria-label="Close">√ó</button>
      `;

      const closeBtn = t.querySelector(".close");
      closeBtn.onclick = ()=> t.remove();

      toasts.appendChild(t);

      setTimeout(()=>{
        if(t.isConnected) t.remove();
      }, ms);
    }

    function setSuggest(items){
      suggest.innerHTML = "";
      items.forEach(v=>{
        const c = document.createElement("div");
        c.className = "chip";
        c.textContent = v;
        c.onclick = ()=>{ text.value = v; text.focus(); };
        suggest.appendChild(c);
      });
    }

    function setLangUI(){
      mnPill.classList.toggle("active", lang==="mn");
      enPill.classList.toggle("active", lang==="en");

      if(lang==="mn"){
        heroSub.textContent = "–ê—Å—É—É–ª—Ç–∞–∞ –±–∏—á—ç—ç—Ä—ç–π";
        text.placeholder = "–≠–Ω–¥ –±–∏—á—ç—ç—Ä—ç–π...";
        setSuggest(["–∞—è–ª–∞–ª","—Ç—É—Å–ª–∞–º–∂","reset","2 —Å–∞—Ä","500$","–Ø–ø–æ–Ω","–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω","–ê–ù–£","–±–∞–π–≥–∞–ª—å","—Å–æ—ë–ª","–∞–¥–∞–ª —è–≤–¥–∞–ª","—Ç–∞–π–≤–∞–Ω","7 ”©–¥”©—Ä","10 ”©–¥”©—Ä","8 —Å–∞—Ä"]);
      } else {
        heroSub.textContent = "Type your question";
        text.placeholder = "Type here...";
        setSuggest(["travel","help","reset","2 months","$500","Japan","Kazakhstan","USA","nature","culture","adventure","quiet","7 days","10 days","August"]);
      }
    }

    async function sendToRasa(message){
      const payload = { sender: senderId, message };
      const res = await fetch(RASA_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      if (!res.ok) throw new Error("Rasa error " + res.status);
      return await res.json();
    }

    // ===== Chat actions =====
    async function handleSend(){
      const msg = text.value.trim();
      if(!msg) return;
      text.value = "";
      addMsg("me", msg);

      statusText.textContent = "Sending...";
      modeText.textContent = "Sending...";
      showTyping(true);

      try{
        const replies = await sendToRasa(msg);
        showTyping(false);

        if(!replies || replies.length === 0){
          addMsg("bot", lang==="mn" ? "–•–∞—Ä–∏—É –æ–ª–¥—Å–æ–Ω–≥“Ø–π. –î–∞—Ö–∏–Ω –æ—Ä–æ–ª–¥–æ–Ω–æ —É—É." : "No reply. Please try again.");
          toast("warn", lang==="mn" ? "–•–∞—Ä–∏—É –æ–ª–¥—Å–æ–Ω–≥“Ø–π" : "No reply", lang==="mn" ? "NLU ”©–≥”©–≥–¥”©–ª –Ω—ç–º—ç—Ö —Ö—ç—Ä—ç–≥—Ç—ç–π –±–∞–π–∂ –º–∞–≥–∞–¥–≥“Ø–π." : "You may need more training examples.");
        } else {
          replies.forEach(r => addMsg("bot", r.text || ""));
        }

        statusText.textContent = "Ready";
        modeText.textContent = "Live";
      }catch(e){
        showTyping(false);
        statusText.textContent = "Demo";
        modeText.textContent = "UI Mode";

        addMsg("bot",
          (lang==="mn"
            ? "‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä—Ç —Ö–æ–ª–±–æ–≥–¥–æ–∂ —á–∞–¥—Å–∞–Ω–≥“Ø–π. Rasa –∞—Å–∞–∞–ª—Ç—Ç–∞–π —ç—Å—ç—Ö–∏–π–≥ —à–∞–ª–≥–∞–∞—Ä–∞–π."
            : "‚ö†Ô∏è Could not reach server. Check if Rasa is running.")
        );

        toast(
          "error",
          lang==="mn" ? "–ê–ª–¥–∞–∞" : "Error",
          (lang==="mn"
            ? "Rasa —Å–µ—Ä–≤–µ—Ä —Ö–æ–ª–±–æ–≥–¥—Å–æ–Ω–≥“Ø–π. (localhost:5005) –∞–∂–∏–ª–ª–∞–∂ –±–∞–π–Ω–∞ —É—É?"
            : "Rasa server not reachable. Is (localhost:5005) running?")
        );
      }
    }

    document.getElementById("send").onclick = handleSend;
    text.addEventListener("keydown", (e)=>{ if(e.key === "Enter") handleSend(); });

    mnPill.onclick = ()=>{ lang="mn"; setLangUI(); };
    enPill.onclick = ()=>{ lang="en"; setLangUI(); };

    document.getElementById("newChatBtn").onclick =
    document.getElementById("newChatBtn2").onclick = ()=>{
      chat.innerHTML = "";
      addMsg("bot", lang==="mn"
        ? "–°–∞–π–Ω –±–∞–π–Ω–∞ —É—É üëã ‚Äú–∞—è–ª–∞–ª‚Äù –≥—ç–∂ –±–∏—á–≤—ç–ª —Ç”©–ª”©–≤–ª”©–∂ —ç—Ö—ç–ª–Ω—ç."
        : "Hi üëã Type ‚Äútravel‚Äù to start planning.");
      statusText.textContent = "Ready";
      modeText.textContent = "Ready";
      toast("ok", lang==="mn" ? "–®–∏–Ω—ç —á–∞—Ç" : "New chat", lang==="mn" ? "–¶—ç–≤—ç—Ä–ª—ç–≥–¥–ª—ç—ç." : "Cleared.");
    };

    // ===== Voice to Text =====
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let rec = null;
    let isRec = false;

    if (SpeechRecognition) {
      rec = new SpeechRecognition();
      rec.continuous = false;
      rec.interimResults = false;

      rec.onstart = ()=>{ isRec=true; micBtn.classList.add("rec"); statusText.textContent="Listening..."; };
      rec.onend = ()=>{ isRec=false; micBtn.classList.remove("rec"); statusText.textContent="Ready"; };
      rec.onerror = ()=>{ isRec=false; micBtn.classList.remove("rec"); toast("error","Mic error","Speech recognition failed."); };

      rec.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        text.value = transcript;
        text.focus();
        toast("ok", lang==="mn" ? "–î—É—É —Ö–æ–æ–ª–æ–π —Ç–∞–Ω–∏–≥–¥–ª–∞–∞" : "Voice captured", transcript, 2500);
      };
    } else {
      micBtn.style.opacity = .5;
      micBtn.title = "SpeechRecognition not supported in this browser.";
    }

    micBtn.onclick = () => {
      if (!rec || isRec) return;
      rec.lang = (lang==="mn") ? "mn-MN" : "en-US";
      rec.start();
    };

    // ===== Auth Modal (Sign in/up) =====
    function openModal(mode){
      authMode = mode;
      modalOverlay.style.display = "flex";
      modalOverlay.setAttribute("aria-hidden", "false");

      if(mode==="signin"){
        modalTitle.textContent = "Sign in";
        nameField.style.display = "none";
        modalPrimary.textContent = "Sign in";
        modalHint.textContent = "Demo UI. Backend —Ö–æ–ª–±–æ–ª—Ç–≥“Ø–π —Ç—É–ª —ç–Ω—ç —Ö—ç—Å—ç–≥ –∑”©–≤—Ö”©–Ω –∑–∞–≥–≤–∞—Ä.";
      } else {
        modalTitle.textContent = "Sign up";
        nameField.style.display = "block";
        modalPrimary.textContent = "Create account";
        modalHint.innerHTML = `Demo UI. –î–∞—Ä–∞–∞ –Ω—å backend —Ö–æ–ª–±–æ—Ö “Ø–µ–¥ –±“Ø—Ä—Ç–≥—ç–ª –∞–∂–∏–ª–ª–∞–Ω–∞. <br/>Want to sign in? <a id="goSignIn">Sign in</a>`;
        setTimeout(()=>{
          const a = document.getElementById("goSignIn");
          if(a) a.onclick = ()=>openModal("signin");
        }, 0);
      }

      // labels (lang)
      if(lang==="mn"){
        labelEmail.textContent = "–ò–º—ç–π–ª";
        labelPass.textContent = "–ù—É—É—Ü “Ø–≥";
        labelName.textContent = "–ù—ç—Ä";
      } else {
        labelEmail.textContent = "Email";
        labelPass.textContent = "Password";
        labelName.textContent = "Full name";
      }
    }

    function closeModal(){
      modalOverlay.style.display = "none";
      modalOverlay.setAttribute("aria-hidden", "true");
    }

    signInBtn.onclick = ()=> openModal("signin");
    signUpBtn.onclick = ()=> openModal("signup");
    modalClose.onclick = closeModal;
    modalSecondary.onclick = closeModal;

    modalOverlay.addEventListener("click", (e)=>{
      if(e.target === modalOverlay) closeModal();
    });

    modalPrimary.onclick = ()=>{
      // Demo: show toast
      if(authMode==="signin"){
        toast("ok", "Signed in (demo)", "UI demo –≥–æ—Ä–∏–º. Backend —Ö–æ–ª–±–æ–ª—Ç–≥“Ø–π.");
      } else {
        toast("ok", "Account created (demo)", "UI demo –≥–æ—Ä–∏–º. Backend —Ö–æ–ª–±–æ–ª—Ç–≥“Ø–π.");
      }
      closeModal();
    };

    // ESC to close modal
    document.addEventListener("keydown", (e)=>{
      if(e.key === "Escape" && modalOverlay.style.display === "flex") closeModal();
    });

    // init
    setLangUI();
  </script>
</body>
</html>
